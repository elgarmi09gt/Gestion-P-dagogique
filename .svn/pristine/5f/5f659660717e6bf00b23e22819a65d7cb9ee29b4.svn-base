package autorisation_inscription;

import java.io.Serializable;

import java.text.DateFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;

import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.Map;

import javax.el.ELContext;
import javax.el.ExpressionFactory;
import javax.el.ValueExpression;

import javax.faces.application.Application;
import javax.faces.application.FacesMessage;
import javax.faces.context.FacesContext;

import javax.faces.event.ActionEvent;

import oracle.adf.view.rich.component.rich.RichPopup;
import oracle.adf.view.rich.component.rich.input.RichInputDate;
import oracle.adf.view.rich.component.rich.input.RichInputText;
import model.services.inscriptionAppImpl;

import oracle.adf.controller.TaskFlowId;

import oracle.adf.model.BindingContext;
import oracle.adf.model.binding.DCIteratorBinding;
import oracle.adf.share.ADFContext;

import oracle.adf.view.rich.event.DialogEvent;
import oracle.adf.view.rich.event.DialogEvent.Outcome;
import oracle.adf.view.rich.render.ClientEvent;

import oracle.binding.AttributeBinding;
import oracle.binding.BindingContainer;

import oracle.binding.OperationBinding;

import oracle.jbo.Row;
import oracle.jbo.RowSetIterator;
import oracle.jbo.VariableValueManager;
import oracle.jbo.ViewCriteria;
import oracle.jbo.ViewCriteriaManager;
import oracle.jbo.ViewObject;

public class AutorisationBean implements Serializable {
    private RichInputText nivFormParc;
    private RichInputText idForm;
    private RichInputText idNiv;
    private String taskFlowId1 = "/inscription/autorisation_inscription/dynamic-task.xml#dynamic-task";
    private RichInputText lib_form;
    private RichInputText nom;
    private RichInputText prenom;
    private RichInputDate date_naiss;
    private RichInputText lieu_naiss;
    private RichInputText adresse;
    private RichInputText cin;
    private RichPopup popup;
    final String OLD_CURR_KEY_VIEWSCOPE_ATTR = "__oldCurrentRowKey__";
    Map sessionScope = ADFContext.getCurrent().getSessionScope();
    private String parcours = sessionScope.get("id_niv_form_parcours").toString();
    private String anne_univers = sessionScope.get("id_annee").toString();
    private String session = sessionScope.get("id_session").toString();
    private String utilisateur = sessionScope.get("id_user").toString();
    private String calendrier = sessionScope.get("id_calendrier").toString();
    private String semestre = sessionScope.get("id_smstre").toString();
    private String prenom_bac;
    private String nom_bac;
    private String date_naiss_bac;
    private String lieu_naiss_bac;
    
    private String table;
    private String numero;
    private String cin_pers;
    
    private String prenom_etud;
    private String nom_etud;
    private String date_naiss_etud;
    private String lieu_naiss_etud;
    private RichInputText num_etud;
    
    private String prenom_cin;
    private String nom_cin;
    private String date_naiss_cin;
    private String lieu_naiss_cin;
    private RichInputText num_table;
    private RichInputText num_cin;

    private String prenom_nouv;
    private String nom_nouv;
    private String date_naiss_nouv;
    private String lieu_naiss_nouv;
    private String cin_nouv;
    private String adresse_nouv;
    private String email_pers_nouv;
    private String portable_nouv;
    private String pays_nouv;
    private String civilite_nouv;
    private String nationalite_nouv;
    private String ine_nouv;
    private Integer bac_nouv;
    private RichPopup pop_insc;


    public AutorisationBean() {
    }


    public void setIne_nouv(String ine_nouv) {
        this.ine_nouv = ine_nouv;
    }

    public String getIne_nouv() {
        return ine_nouv;
    }

    public void setBac_nouv(Integer bac_nouv) {
        this.bac_nouv = bac_nouv;
    }

    public Integer getBac_nouv() {
        return bac_nouv;
    }

    public void setCin_nouv(String cin_nouv) {
        this.cin_nouv = cin_nouv;
    }

    public String getCin_nouv() {
        return cin_nouv;
    }

    public void setAdresse_nouv(String adresse_nouv) {
        this.adresse_nouv = adresse_nouv;
    }

    public String getAdresse_nouv() {
        return adresse_nouv;
    }

    public void setEmail_pers_nouv(String email_pers_nouv) {
        this.email_pers_nouv = email_pers_nouv;
    }

    public String getEmail_pers_nouv() {
        return email_pers_nouv;
    }

    public void setPortable_nouv(String portable_nouv) {
        this.portable_nouv = portable_nouv;
    }

    public String getPortable_nouv() {
        return portable_nouv;
    }

    public void setPays_nouv(String pays_nouv) {
        this.pays_nouv = pays_nouv;
    }

    public String getPays_nouv() {
        return pays_nouv;
    }

    public void setCivilite_nouv(String civilite_nouv) {
        this.civilite_nouv = civilite_nouv;
    }

    public String getCivilite_nouv() {
        return civilite_nouv;
    }

    public void setNationalite_nouv(String nationalite_nouv) {
        this.nationalite_nouv = nationalite_nouv;
    }

    public String getNationalite_nouv() {
        return nationalite_nouv;
    }

    public void setPrenom_nouv(String prenom_nouv) {
        this.prenom_nouv = prenom_nouv;
    }

    public String getPrenom_nouv() {
        return prenom_nouv;
    }

    public void setNom_nouv(String nom_nouv) {
        this.nom_nouv = nom_nouv;
    }

    public String getNom_nouv() {
        return nom_nouv;
    }

    public void setDate_naiss_nouv(String date_naiss_nouv) {
        this.date_naiss_nouv = date_naiss_nouv;
    }

    public String getDate_naiss_nouv() {
        return date_naiss_nouv;
    }

    public void setLieu_naiss_nouv(String lieu_naiss_nouv) {
        this.lieu_naiss_nouv = lieu_naiss_nouv;
    }

    public String getLieu_naiss_nouv() {
        return lieu_naiss_nouv;
    }

    public void setTable(String table) {
        this.table = table;
    }

    public String getTable() {
        return table;
    }

    public void setNumero(String numero) {
        this.numero = numero;
    }

    public String getNumero() {
        return numero;
    }

    public void setCin_pers(String cin_pers) {
        this.cin_pers = cin_pers;
    }

    public String getCin_pers() {
        return cin_pers;
    }

    public void setPrenom_cin(String prenom_cin) {
        this.prenom_cin = prenom_cin;
    }

    public String getPrenom_cin() {
        return prenom_cin;
    }

    public void setNom_cin(String nom_cin) {
        this.nom_cin = nom_cin;
    }

    public String getNom_cin() {
        return nom_cin;
    }

    public void setDate_naiss_cin(String date_naiss_cin) {
        this.date_naiss_cin = date_naiss_cin;
    }

    public String getDate_naiss_cin() {
        return date_naiss_cin;
    }

    public void setLieu_naiss_cin(String lieu_naiss_cin) {
        this.lieu_naiss_cin = lieu_naiss_cin;
    }

    public String getLieu_naiss_cin() {
        return lieu_naiss_cin;
    }

    public void setPrenom_etud(String prenom_etud) {
        this.prenom_etud = prenom_etud;
    }

    public String getPrenom_etud() {
        return prenom_etud;
    }

    public void setNom_etud(String nom_etud) {
        this.nom_etud = nom_etud;
    }

    public String getNom_etud() {
        return nom_etud;
    }

    public void setDate_naiss_etud(String date_naiss_etud) {
        this.date_naiss_etud = date_naiss_etud;
    }

    public String getDate_naiss_etud() {
        return date_naiss_etud;
    }

    public void setLieu_naiss_etud(String lieu_naiss_etud) {
        this.lieu_naiss_etud = lieu_naiss_etud;
    }

    public String getLieu_naiss_etud() {
        return lieu_naiss_etud;
    }


    public void setPrenom_bac(String prenom_bac) {
        this.prenom_bac = prenom_bac;
    }

    public String getPrenom_bac() {
        return prenom_bac;
    }

    public void setNom_bac(String nom_bac) {
        this.nom_bac = nom_bac;
    }

    public String getNom_bac() {
        return nom_bac;
    }

    public void setDate_naiss_bac(String date_naiss_bac) {
        this.date_naiss_bac = date_naiss_bac;
    }

    public String getDate_naiss_bac() {
        return date_naiss_bac;
    }

    public void setLieu_naiss_bac(String lieu_naiss_bac) {
        this.lieu_naiss_bac = lieu_naiss_bac;
    }

    public String getLieu_naiss_bac() {
        return lieu_naiss_bac;
    }


    public void setAnne_univers(String anne_univers) {
        this.anne_univers = anne_univers;
    }

    public String getAnne_univers() {
        return anne_univers;
    }

    public void setSession(String session) {
        this.session = session;
    }

    public String getSession() {
        return session;
    }

    public void setUtilisateur(String utilisateur) {
        this.utilisateur = utilisateur;
    }

    public String getUtilisateur() {
        return utilisateur;
    }

    public void setCalendrier(String calendrier) {
        this.calendrier = calendrier;
    }

    public String getCalendrier() {
        return calendrier;
    }

    public void setSemestre(String semestre) {
        this.semestre = semestre;
    }

    public String getSemestre() {
        return semestre;
    }

    public Object resolvElDC(String data) {
        FacesContext fc = FacesContext.getCurrentInstance();
        Application app = fc.getApplication();
        ExpressionFactory elFactory = app.getExpressionFactory();
        ELContext elContext = fc.getELContext();
        ValueExpression valueExp =
            elFactory.createValueExpression(elContext, "#{data." + data + ".dataProvider}", Object.class);
        return valueExp.getValue(elContext);
    }


    public String search() {
        inscriptionAppImpl am = (inscriptionAppImpl)resolvElDC("inscriptionAppDataControl");
        ViewObject liste_persVo = am.getListePersonnesROVO();
        
        ViewCriteriaManager vcm = liste_persVo.getViewCriteriaManager();
        ViewCriteria vc = vcm.getViewCriteria("ListePersonnesROVOCriteria");
        VariableValueManager vvm =vc.ensureVariableManager();
        vvm.setVariableValue("nom_bn", nom.getValue());
        vvm.setVariableValue("prenom", prenom.getValue());
        vvm.setVariableValue("date_naiss", date_naiss.getValue());
        vvm.setVariableValue("lieu_naiss", lieu_naiss.getValue());
        vvm.setVariableValue("adresse_bn", adresse.getValue());
        vvm.setVariableValue("cin", cin.getValue());                                                          
        liste_persVo.applyViewCriteria(vc);
        liste_persVo.executeQuery();
        
        return null;
    }

    public void setNivFormParc(RichInputText nivFormParc) {
        this.nivFormParc = nivFormParc;
    }

    public RichInputText getNivFormParc() {
        return nivFormParc;
    }

    public void setIdForm(RichInputText idForm) {
        this.idForm = idForm;
    }

    public RichInputText getIdForm() {
        return idForm;
    }

    public void setIdNiv(RichInputText idNiv) {
        this.idNiv = idNiv;
    }

    public RichInputText getIdNiv() {
        return idNiv;
    }

    public String reset() {
        // Add event code here...
        inscriptionAppImpl am = (inscriptionAppImpl)resolvElDC("inscriptionAppDataControl");
        ViewObject empVo = am.getListePersonnesROVO();
        ViewObject attrVo=am.getAttrSearchPers();
        ViewCriteriaManager vcm = empVo.getViewCriteriaManager();
        ViewCriteria vc = vcm.getViewCriteria("ListePersonnesROVOCriteria");
        VariableValueManager vvm =vc.ensureVariableManager();
        vvm.setVariableValue("nom_bn", null);
        vvm.setVariableValue("prenom", null);
        vvm.setVariableValue("date_naiss", null);
        vvm.setVariableValue("lieu_naiss", null);
        vvm.setVariableValue("adresse_bn", null);
        vvm.setVariableValue("cin", null);
        empVo.applyViewCriteria(vc);
        empVo.executeQuery();
        empVo.executeQuery();
        attrVo.executeQuery();
        return null;
    }

    @SuppressWarnings("unchecked")
    public List semestreNiv(Integer niv){
        List tab = new ArrayList();
        if(niv == 1){
            tab.add("1");
            tab.add("2");
        }
        else if(niv == 2){
                tab.add("3");
                tab.add("4");
        }
        else if(niv == 3){
                tab.add("5");
                tab.add("6");
        }
        else if(niv == 4){
                tab.add("1");
                tab.add("2");
        }
        else if(niv == 5){
                tab.add("3");
                tab.add("4");
        }
        return tab;
    }
    
    @SuppressWarnings("unchecked")
    public Row recherche(){
        Row row_det_pers = null;
        System.out.println("getTable() inte "+getTable());
        if((String)this.getTable() == null && (String)this.getCin_pers() == null && (String)this.getNumero() == null){

            if((String)this.getPrenom_nouv() == null && (String)this.getNom_nouv() == null 
                && (String)this.getDate_naiss_nouv() == null && (String)this.getLieu_naiss_nouv() == null
                && (String)this.getCin_nouv() == null && (String)this.getAdresse_nouv() == null 
                && (String)this.getEmail_pers_nouv() == null && (String)this.getPortable_nouv() == null){
                
                FacesMessage msg = new FacesMessage(" Veuillez saisir soit :");
                msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                FacesContext.getCurrentInstance().addMessage(null, msg);
                FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Un numéro de Table"));
                FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Un numéro Etudiant"));
                FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Un numéro d'Identification Nationale (CIN)"));
                FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Les informations personnelles "));
            }

            else if((String)this.getPrenom_nouv() == null || (String)this.getNom_nouv() == null || (String)this.getDate_naiss_nouv() == null || (String)this.getLieu_naiss_nouv() == null
            || (String)this.getCin_nouv() == null || (String)this.getAdresse_nouv() == null || (String)this.getEmail_pers_nouv() == null || (String)this.getPortable_nouv() == null){
            
                FacesMessage msg = new FacesMessage(" Tous les champs sont obliqatoires :");
                msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                FacesContext.getCurrentInstance().addMessage(null, msg);
                
                if((String)this.getPrenom_nouv() == null){
                    FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" --> Prénom"));
                }
                if((String)this.getNom_nouv() == null){
                    FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" --> Nom"));
                }
                if((String)this.getDate_naiss_nouv() == null){
                    FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" --> Date Naissance"));
                }
                if((String)this.getLieu_naiss_nouv() == null){
                    FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" --> Lieu de Naissance"));
                }
                if((String)this.getCin_nouv() == null){
                    FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" --> Numéro d'Identification Nationale"));
                }
                if((String)this.getAdresse_nouv() == null){
                    FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" --> Adresse"));
                }
                if((String)this.getEmail_pers_nouv() == null){
                    FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" --> Email personnel"));
                }
                if((String)this.getPortable_nouv() == null){
                    FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" --> Portable"));
                }

            }
            else if((String)this.getPrenom_nouv() != null && (String)this.getNom_nouv() != null && (String)this.getDate_naiss_nouv() != null && (String)this.getLieu_naiss_nouv() != null
            
            && (String)this.getCin_nouv() != null && (String)this.getAdresse_nouv() != null && (String)this.getEmail_pers_nouv() != null && (String)this.getPortable_nouv() != null){

                AttributeBinding nom = (AttributeBinding) getBindings().getControlBinding("Nom1");
                AttributeBinding prenom = (AttributeBinding) getBindings().getControlBinding("Prenoms1");
                AttributeBinding date_naiss = (AttributeBinding) getBindings().getControlBinding("DateNaissance");
                AttributeBinding lieu_naiss = (AttributeBinding) getBindings().getControlBinding("LieuNaissance");
                AttributeBinding email_pers = (AttributeBinding) getBindings().getControlBinding("EmailPersonnel");
                AttributeBinding adresse = (AttributeBinding) getBindings().getControlBinding("Adresse");
                AttributeBinding portable = (AttributeBinding) getBindings().getControlBinding("Portable");
                AttributeBinding pays = (AttributeBinding) getBindings().getControlBinding("IdPays");
                AttributeBinding pays_nationalite = (AttributeBinding) getBindings().getControlBinding("IdPaysNationalite");
                AttributeBinding civilite = (AttributeBinding) getBindings().getControlBinding("IdCivilite");
                AttributeBinding cin = (AttributeBinding) getBindings().getControlBinding("PieceIdentification");
                AttributeBinding util = (AttributeBinding) getBindings().getControlBinding("UtiCreePersonne");
                
                AttributeBinding civilite_select = (AttributeBinding) getBindings().getControlBinding("IdCiviliteCivilite");
                AttributeBinding pays_select = (AttributeBinding) getBindings().getControlBinding("IdPaysPays");
                AttributeBinding nation_select = (AttributeBinding) getBindings().getControlBinding("IdPaysNationaliteSearch");
                
                AttributeBinding sexe_pers = (AttributeBinding) getBindings().getControlBinding("IdSexePers");
                AttributeBinding ine_pers = (AttributeBinding) getBindings().getControlBinding("Ine");
                AttributeBinding sexe_sexe = (AttributeBinding) getBindings().getControlBinding("IdSexeSexe");
                // formatage de date de naiss
                DateFormat dateFormat = new SimpleDateFormat("dd/MM/yyyy");
                Date date = null;
                try {
                    date = dateFormat.parse(getDate_naiss_nouv());
                    System.out.println(date.toString()); // Wed Dec 04 00:00:00 CST 2013

                    String output = dateFormat.format(date);
                    System.out.println(output); // 2013-12-04
                } 
                catch (ParseException e) {
                    e.printStackTrace();
                }
                // si personne existe deja avec toutes les infos personnelles
                OperationBinding pers_existe = getBindings().getOperationBinding("getPersExiste");
                pers_existe.getParamsMap().put("nom_pers",  getNom_nouv());
                pers_existe.getParamsMap().put("prenom",  getPrenom_nouv());
                pers_existe.getParamsMap().put("date_naiss",  getDate_naiss_nouv());
                pers_existe.getParamsMap().put("lieu_naiss",  getLieu_naiss_nouv());
                pers_existe.getParamsMap().put("email_pers",  getEmail_pers_nouv());
                pers_existe.getParamsMap().put("adress",  getAdresse_nouv());
                pers_existe.getParamsMap().put("portable_pers",  getPortable_nouv());
                pers_existe.getParamsMap().put("id_paays",  Long.parseLong(pays_select.getInputValue().toString()));
                pers_existe.getParamsMap().put("id_nation",  Long.parseLong(nation_select.getInputValue().toString()));
                pers_existe.getParamsMap().put("id_civi",  Long.parseLong(civilite_select.getInputValue().toString()));
                pers_existe.getParamsMap().put("cin",  getCin_nouv());
                pers_existe.execute();
                
                DCIteratorBinding iter_pers_existe = (DCIteratorBinding) getBindings().get("PersonneExisteIterator");
                Row cuurrent_row = iter_pers_existe.getCurrentRow();
                if(cuurrent_row != null){
                    row_det_pers = cuurrent_row;
                }
                else{
                    OperationBinding operationBinding = getBindings().getOperationBinding("CreateInsertPersonne");
                    Object result = operationBinding.execute();
                    if (!operationBinding.getErrors().isEmpty()) {
                        return null;
                    }
                    else{
                        nom.setInputValue(getNom_nouv());
                        prenom.setInputValue(getPrenom_nouv());
                        date_naiss.setInputValue(date);
                        lieu_naiss.setInputValue(getLieu_naiss_nouv());
                        email_pers.setInputValue(getEmail_pers_nouv());
                        adresse.setInputValue(getAdresse_nouv());
                        portable.setInputValue(getPortable_nouv());
                        pays.setInputValue(Long.parseLong(pays_select.getInputValue().toString())); // par defaut Senegal
                        pays_nationalite.setInputValue(Long.parseLong(nation_select.getInputValue().toString()));       // par defaut nationalité sénégalaise
                        civilite.setInputValue(Long.parseLong(civilite_select.getInputValue().toString()));
                        cin.setInputValue(getCin_nouv());
                        util.setInputValue(Long.parseLong(sessionScope.get("id_user").toString()));
                        
                        ine_pers.setInputValue(getIne_nouv());
                        
                        sexe_pers.setInputValue(sexe_sexe.getInputValue());
                        
                        OperationBinding op_pers_commit = getBindings().getOperationBinding("Commit");
                        Object result_pers_commit = op_pers_commit.execute();
                        if (!op_pers_commit.getErrors().isEmpty()) {
                            return null;
                        }
                        
                        else{
                            AttributeBinding id_pers_insert = (AttributeBinding) getBindings().getControlBinding("IdPersonne");
                            System.out.println("id_pers_insert " +id_pers_insert);
                            OperationBinding detpers = getBindings().getOperationBinding("getDetailPers");
                            detpers.getParamsMap().put("idpers_var",  Long.parseLong(id_pers_insert.getInputValue().toString()));
                            detpers.execute();
                            
                            DCIteratorBinding iter_det_pers = (DCIteratorBinding)getBindings().get("PersonnesIterator");
                                //Create RowSetIterato iterate over viewObject
                            RowSetIterator rsi_det_pers = iter_det_pers.getViewObject().createRowSetIterator(null);
                            row_det_pers = rsi_det_pers.first();
                        }
    
                    }
                }
        }
            
        }
        else{
            if((String)this.getTable() != null){
                OperationBinding is_nouv_bac = getBindings().getOperationBinding("isNumNouvBac");
                is_nouv_bac.getParamsMap().put("num_table",  Long.parseLong((String)this.getTable().toString()));
                is_nouv_bac.getParamsMap().put("id_annee",  Long.parseLong(getAnne_univers()));
                
                Integer result = (Integer)is_nouv_bac.execute();
                //numéro table non valide
                if(result != 0){
                    OperationBinding getIdPersEtudiant = getBindings().getOperationBinding("getIdPersBac");
                    getIdPersEtudiant.getParamsMap().put("num_table",  Long.parseLong((String)this.getTable().toString()));
                    getIdPersEtudiant.getParamsMap().put("id_annee",  Long.parseLong(getAnne_univers()));
                    String result_getid = (String)getIdPersEtudiant.execute();   
                    OperationBinding detpers = getBindings().getOperationBinding("getDetailPers");
                    detpers.getParamsMap().put("idpers_var",  Long.parseLong(result_getid));
                    detpers.execute();
                    
                    DCIteratorBinding iter_det_pers = (DCIteratorBinding)getBindings().get("PersonnesIterator");
                        //Create RowSetIterato iterate over viewObject
                    RowSetIterator rsi_det_pers = iter_det_pers.getViewObject().createRowSetIterator(null);
                    row_det_pers = rsi_det_pers.first();
    
                }
                else{
                    FacesMessage msg = new FacesMessage(" Le numéro de table : "+getTable()+" n'existe pas");
                    msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                    FacesContext.getCurrentInstance().addMessage(null, msg);
                    setTable("");
                    sessionScope.put("tableNotNull", 0);
                }
    
            }
            else {
                if((String)this.getNumero() != null ){
                    OperationBinding isEtudiant = getBindings().getOperationBinding("isNumEtudiant");
                    isEtudiant.getParamsMap().put("num_etud",  (String)this.getNumero());
                    
                    Integer result = (Integer)isEtudiant.execute();
                    //numéro étudiant non valide
                    if(result != 0){
                        //numéro étudiant valide
                        // recuperer id personn de l etudiant
                        OperationBinding getIdPersEtudiant = getBindings().getOperationBinding("getIdPersEtudiant");
                        getIdPersEtudiant.getParamsMap().put("num_etud",  (String)this.getNumero());                            
                        String result_getid = (String)getIdPersEtudiant.execute(); 
        
                        OperationBinding detpers = getBindings().getOperationBinding("getDetailPers");
                        detpers.getParamsMap().put("idpers_var",  Long.parseLong(result_getid));
                        detpers.execute();
                        
                        DCIteratorBinding iter_det_pers = (DCIteratorBinding)getBindings().get("PersonnesIterator");
                            //Create RowSetIterato iterate over viewObject
                        RowSetIterator rsi_det_pers = iter_det_pers.getViewObject().createRowSetIterator(null);
                        row_det_pers = rsi_det_pers.first();
    
                    }
                    else{
                        FacesMessage msg = new FacesMessage(" Le numéro d'étudiant : "+getNumero()+" n'existe pas");
                        msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                        FacesContext.getCurrentInstance().addMessage(null, msg);
                        setNumero("");
                        sessionScope.put("etudNotNull", 0);
                    }
                }
                else {
                    if((String)this.getCin_pers() != null ){
                        //vérifier le numéro d'identification
                        OperationBinding isEtudiant = getBindings().getOperationBinding("isNumCin");
                        isEtudiant.getParamsMap().put("num_cin",  (String)this.getCin_pers());
                        
                        Integer result = (Integer)isEtudiant.execute();
                        // le numéro d'identification non valide            
                        if(result != 0){
                            // le numéro d'identification valide
                            // recuperer id personn de l etudiant
                            OperationBinding getIdPersEtudiant = getBindings().getOperationBinding("getIdPersCin");
                            getIdPersEtudiant.getParamsMap().put("cin",  (String)this.getCin_pers());  
                            String result_getid = (String)getIdPersEtudiant.execute(); 
        
                            OperationBinding detpers = getBindings().getOperationBinding("getDetailPers");
                            detpers.getParamsMap().put("idpers_var",  Long.parseLong(result_getid));
                            detpers.execute();
                            
                            DCIteratorBinding iter_det_pers = (DCIteratorBinding)getBindings().get("PersonnesIterator");
                                //Create RowSetIterato iterate over viewObject
                            RowSetIterator rsi_det_pers = iter_det_pers.getViewObject().createRowSetIterator(null);
                            row_det_pers = rsi_det_pers.first();
                        }
                        else{
                            FacesMessage msg = new FacesMessage(" Le numéro d'identification : "+getCin_pers()+" n'existe pas");
                            msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                            FacesContext.getCurrentInstance().addMessage(null, msg);
                            setCin_pers("");
                            sessionScope.put("cinNotNull", 0);
                        }
                    }
                }
            }
        }
        return row_det_pers;
    }

    @SuppressWarnings("oracle.jdeveloper.java.unchecked-conversion-or-cast")
    public String listeAutorisation() {
        // Add event code here...
        return null;
    }

    public TaskFlowId getDynamicTaskFlowId1() {
        return TaskFlowId.parse(taskFlowId1);
    }

    public void setDynamicTaskFlowId1(String taskFlowId) {
        this.taskFlowId1 = taskFlowId;
    }
    public BindingContainer getBindings() {
        return (BindingContainer) BindingContext.getCurrent().getCurrentBindingsEntry();
    }
    public void onListeAutorisation(ActionEvent actionEvent) {
    }

    public void onRacherche(ActionEvent actionEvent) {
        // Add event code here...
        inscriptionAppImpl am = (inscriptionAppImpl)resolvElDC("inscriptionAppDataControl");
        ViewObject empVo = am.getNivFormAutoriseRO();
        empVo.setNamedWhereClauseParam("id_niv_form", nivFormParc.getValue());
        empVo.setNamedWhereClauseParam("id_form", idForm.getValue());
        empVo.setNamedWhereClauseParam("id_niv", idNiv.getValue());
        empVo.executeQuery();
    }

    public void setLib_form(RichInputText lib_form) {
        this.lib_form = lib_form;
    }

    public RichInputText getLib_form() {
        return lib_form;
    }

    public void setNom(RichInputText nom) {
        this.nom = nom;
    }

    public RichInputText getNom() {
        return nom;
    }

    public void setPrenom(RichInputText prenom) {
        this.prenom = prenom;
    }

    public RichInputText getPrenom() {
        return prenom;
    }

    public void setDate_naiss(RichInputDate date_naiss) {
        this.date_naiss = date_naiss;
    }

    public RichInputDate getDate_naiss() {
        return date_naiss;
    }

    public void setLieu_naiss(RichInputText lieu_naiss) {
        this.lieu_naiss = lieu_naiss;
    }

    public RichInputText getLieu_naiss() {
        return lieu_naiss;
    }

    public void setAdresse(RichInputText adresse) {
        this.adresse = adresse;
    }

    public RichInputText getAdresse() {
        return adresse;
    }

    public void setCin(RichInputText cin) {
        this.cin = cin;
    }

    public RichInputText getCin() {
        return cin;
    }

    public void setPopup(RichPopup popup) {
        this.popup = popup;
    }

    public RichPopup getPopup() {
        return popup;
    }

    public void onDialogCancel(ClientEvent clientEvent) {
        // Add event code here...
        RichPopup popup = this.getPopup();
        popup.hide();
    }

    @SuppressWarnings("unchecked")
    public void onDialog(DialogEvent dialogEvent) {
        // Add event code here...
        AttributeBinding id_parc_maquette = (AttributeBinding) getBindings().getControlBinding("IdParcoursMaquetAnneeNivForm");
        AttributeBinding id_annee = (AttributeBinding) getBindings().getControlBinding("IdAnneesUnivers");
        
        DCIteratorBinding dciter = (DCIteratorBinding) getBindings().get("ListePersAutNewROIterator");
        Row currentRow = dciter.getCurrentRow();
        
        OperationBinding op_auto_insc = getBindings().getOperationBinding("getInfoAutorise");
        op_auto_insc.getParamsMap().put("id_parc_maq",  Long.parseLong(id_parc_maquette.getInputValue().toString()));
        op_auto_insc.getParamsMap().put("id_annee",  Long.parseLong(id_annee.getInputValue().toString()));  
        op_auto_insc.getParamsMap().put("id_pers",  Long.parseLong(currentRow.getAttribute("IdPersonne").toString()));
        op_auto_insc.execute();
        
        AttributeBinding id_autorise = (AttributeBinding) getBindings().getControlBinding("IdAutorise");
        
        OperationBinding annuler_auto = getBindings().getOperationBinding("getAutorisation");

        annuler_auto.getParamsMap().put("id_autorise", Long.parseLong(id_autorise.getInputValue().toString()));
        annuler_auto.execute();
        
        OperationBinding operationDelete = getBindings().getOperationBinding("DeleteAutorise");
        Object result = operationDelete.execute();
        if (!operationDelete.getErrors().isEmpty()) {
            return;
        }
        else{
           OperationBinding operationCommit = getBindings().getOperationBinding("Commit");
            Object commitResult = operationCommit.execute();
            if (!operationCommit.getErrors().isEmpty()) {
                return;
            }
            else{
                OperationBinding op_refresh = getBindings().getOperationBinding("refreshTableAutorise");
                op_refresh.getParamsMap().put("id_parc_maq",  Long.parseLong(id_parc_maquette.getInputValue().toString()));
                op_refresh.getParamsMap().put("id_annee",  Long.parseLong(getAnne_univers()));
                op_refresh.execute();
            }
            
        }
    }

    public Integer nombreCaseCoche(String bind_interator){
        DCIteratorBinding iter = (DCIteratorBinding) getBindings().get(bind_interator);       
        RowSetIterator rsi = iter.getViewObject().createRowSetIterator(null);
        Integer i = 0;
        while (rsi.hasNext()) {
            Row nextRow = rsi.next();
            if(nextRow.getAttribute("case_cocher")!=null){
                if(Boolean.parseBoolean(nextRow.getAttribute("case_cocher").toString())){
                    i++;
                }
            }
        }
        return i;
    }

    public void onNewPersonne(ActionEvent actionEvent) {
        // Add event code here...
        ADFContext adfCtx = ADFContext.getCurrent();
        Map sessionScope = adfCtx.getSessionScope();
        AttributeBinding util = (AttributeBinding) getBindings().getControlBinding("UtiCree");

        DCIteratorBinding dciter = (DCIteratorBinding) getBindings().get("PersonnesIterator");
        Row oldCcurrentRow = dciter.getCurrentRow();
        if(oldCcurrentRow!=null)
            adfCtx.getViewScope().put(OLD_CURR_KEY_VIEWSCOPE_ATTR, oldCcurrentRow.getKey().toStringFormat(true));
        OperationBinding operationBinding = getBindings().getOperationBinding("CreateInsertPersonne");
        Object result = operationBinding.execute();
        if (!operationBinding.getErrors().isEmpty()) {
            return ;
        }
        else{
            util.setInputValue(Long.parseLong(sessionScope.get("id_user").toString()));
            RichPopup popup = this.getPopup();
            RichPopup.PopupHints hints = new RichPopup.PopupHints();
            popup.show(hints);
        }
    }


    @SuppressWarnings("unchecked")
    public String onValiderAutorisation() {
        Map sessionScope = ADFContext.getCurrent().getSessionScope();
        sessionScope.put("mandatory", 1);
        // Add event code here...
        DateFormat dateFormat = new SimpleDateFormat("dd/MM/yyyy");
        AttributeBinding id_parc_maquette = (AttributeBinding) getBindings().getControlBinding("IdParcoursMaquetAnneeNivForm");

        DCIteratorBinding iter = (DCIteratorBinding) getBindings().get("ListePersonnesROVOIterator");        
        RowSetIterator rsi = iter.getViewObject().createRowSetIterator(null);
        
        Integer i =0;                
        Row row_global_form = infoGlobalForm(id_parc_maquette.getInputValue().toString());
        
        if (row_global_form == null) {
            FacesMessage msg = new FacesMessage( " Pas de Formation ");
            msg.setSeverity(FacesMessage.SEVERITY_ERROR);
            FacesContext.getCurrentInstance().addMessage(null, msg);
            return null;
        }
        else{
            // dans le cas où l'année est fermée
            if(Integer.parseInt(row_global_form.getAttribute("Active").toString()) == 0){
                FacesMessage msg = new FacesMessage( " Impossible de valider l'autorisation car l'année universitaire est déjà fermée ! ");
                msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                FacesContext.getCurrentInstance().addMessage(null, msg);
            }
            else{
                // dans le cas où la formation est fermée
                if(Integer.parseInt(row_global_form.getAttribute("FormOuvert").toString()) == 0){
                    FacesMessage msg = new FacesMessage( " Impossible de valider l'autorisation car la formation est déjà fermée ! ");
                    msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                    FacesContext.getCurrentInstance().addMessage(null, msg);
                }
                else{  
                    Row nextRow = recherche(); 
                    if(nextRow != null){
                        OperationBinding is_etudiant = getBindings().getOperationBinding("isEtudiant");
                        is_etudiant.getParamsMap().put("id_pers",  Long.parseLong(nextRow.getAttribute("IdPersonne").toString()));               
                        Integer res_is_etud = (Integer)is_etudiant.execute(); 
                        
                        Row info_autorisation = autoriserInsc(nextRow.getAttribute("IdPersonne").toString(),id_parc_maquette.getInputValue().toString(), getAnne_univers());
                        //si la personne est deja un etudiant
                        //etatEtudExcluSuspendu
                        if(res_is_etud > 0){
                            // vérifie si l'etudiant est exclu
                            OperationBinding etatEtudExcluSuspendu = getBindings().getOperationBinding("etatEtudExcluSuspendu");
                            etatEtudExcluSuspendu.getParamsMap().put("id_pers",  Long.parseLong(nextRow.getAttribute("IdPersonne").toString()));               
                            etatEtudExcluSuspendu.getParamsMap().put("id_exclu",  Long.parseLong("61"));    // Etat d'inscription d'exclusion (61)
                            etatEtudExcluSuspendu.execute(); 
                            DCIteratorBinding iter_exclu_suspendu = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("EtudiantExcluSuspenduROIterator");
                            Row row_exclu_suspendu = iter_exclu_suspendu.getCurrentRow();
                            if (row_exclu_suspendu != null) {
                                FacesMessage msg = new FacesMessage( " Impossible d'autoriser l'étudiant "+ nextRow.getAttribute("Nom").toString()+" "+nextRow.getAttribute("Prenoms").toString()+" à s'inscrire parce qu'il est "+row_exclu_suspendu.getAttribute("Libelle")+" depuis l'année universitaire: "+row_exclu_suspendu.getAttribute("LibelleLong"));
                                msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                FacesContext.getCurrentInstance().addMessage(null, msg);
                                getRowPers(nextRow);
                            }
                            else{
                                // suspendu pour une durée
                                
                                OperationBinding list_susp = getBindings().getOperationBinding("getListeSuspension");
                                list_susp.getParamsMap().put("idpers",  Long.parseLong(nextRow.getAttribute("IdPersonne").toString()));
                                list_susp.execute();
                                DCIteratorBinding iter_list_susp = (DCIteratorBinding)getBindings().get("ListeSuspensioneEtudROIterator");
                                RowSetIterator rsi_list_susp = iter_list_susp.getViewObject().createRowSetIterator(null);
                                Row row_susp = rsi_list_susp.last();
                                
                                if( row_susp != null && is_suspendu(row_susp) > 0 ){
                                    SimpleDateFormat date_format_annee = new SimpleDateFormat("yyyy");
                                    Date date_fin_susp = (Date)row_susp.getAttribute("DateFin");
                                    FacesMessage msg = new FacesMessage( " Impossible d'autoriser l'étudiant du nom & prénom : "+ nextRow.getAttribute("Nom").toString()+" "+nextRow.getAttribute("Prenoms").toString()+" qui est suspendu jusqu'au "+dateFormat.format(date_fin_susp)+" ("+date_format_annee.format(date_fin_susp)+"-"+(Integer.parseInt(date_format_annee.format(date_fin_susp)) + 1)+" )");
                                    msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                    FacesContext.getCurrentInstance().addMessage(null, msg);
                                }
                                else{
                                    
                                    //verifier si l'étudiant a déjà validé le niveau formation
                                    //getResulAnnValide
                                    OperationBinding niv_form_valide = getBindings().getOperationBinding("getResulAnnValide");
                                    niv_form_valide.getParamsMap().put("idpers",  Long.parseLong(nextRow.getAttribute("IdPersonne").toString()));
                                    niv_form_valide.getParamsMap().put("id_parcours",  Long.parseLong(id_parc_maquette.getInputValue().toString()));
                                    niv_form_valide.execute();
                                    DCIteratorBinding iter_res_val = (DCIteratorBinding)getBindings().get("AutoResulAnnValideROIterator");
                                    Row rw_niv_form_val = iter_res_val.getCurrentRow();
                                    if(rw_niv_form_val != null) {
                                        FacesMessage msg = new FacesMessage( " L'étudiant du nom & prénom : "+ nextRow.getAttribute("Nom").toString()+" "+nextRow.getAttribute("Prenoms").toString()+" a déjà validé "+row_global_form.getAttribute("LibNivForm")+" depuis l'année univers ( "+rw_niv_form_val.getAttribute("LibelleLong")+" )");
                                        msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                        FacesContext.getCurrentInstance().addMessage(null, msg);
                                    }
                                    else{
                                        //Aucune autorisation encours
                                        if(info_autorisation == null){
                                            autoriserEtudiant(nextRow.getAttribute("IdPersonne").toString(), id_parc_maquette.getInputValue().toString(), getAnne_univers(),nextRow.getAttribute("Nom").toString(),nextRow.getAttribute("Prenoms").toString());
                                        }
                                        else{
                                            FacesMessage msg = new FacesMessage( " L'étudiant du nom & prénom : "+ nextRow.getAttribute("Nom").toString()+" "+nextRow.getAttribute("Prenoms").toString()+" est déjà autorisé à s'inscrire en "+row_global_form.getAttribute("LibNivForm")+" pour l'année encours ( "+row_global_form.getAttribute("LibAnnee")+" )");
                                            msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                            FacesContext.getCurrentInstance().addMessage(null, msg);
                                            getRowPers(nextRow);
                                        }
                                    }
                                }
                            }
                        }
                        //si la personne n'est pas un etudiant
                        else{               
                            if(info_autorisation == null){
                                autoriser(nextRow.getAttribute("IdPersonne").toString(), id_parc_maquette.getInputValue().toString(), getAnne_univers(),nextRow.getAttribute("Nom").toString(),nextRow.getAttribute("Prenoms").toString(),nextRow.getAttribute("IdPaysNationalite").toString());
                            }
                            else{
                                FacesMessage msg = new FacesMessage( " L'étudiant du nom & prénom : "+ nextRow.getAttribute("Nom").toString()+" "+nextRow.getAttribute("Prenoms").toString()+" est déjà autorisé à s'inscrire en "+row_global_form.getAttribute("LibNivForm")+" pour l'année encours ( "+row_global_form.getAttribute("LibAnnee")+" )");
                                msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                FacesContext.getCurrentInstance().addMessage(null, msg);
                                if((String)this.getCin_pers() != null ){
                                    setPrenom_cin(nextRow.getAttribute("Prenoms").toString());
                                    setNom_cin(nextRow.getAttribute("Nom").toString());
                                    java.util.Date utilDate = new java.util.Date(((Date)nextRow.getAttribute("DateNaissance")).getTime());
                                    
                                    //DateFormat dateFormat = new SimpleDateFormat("dd/MM/yyyy");
                                    String date_naissance = dateFormat.format(utilDate);
                                    setDate_naiss_cin(date_naissance);
                                    setLieu_naiss_cin(nextRow.getAttribute("LieuNaissance").toString());
                                }
                                else if((String)this.getTable() != null ){
                                        setPrenom_bac(nextRow.getAttribute("Prenoms").toString());
                                        setNom_bac(nextRow.getAttribute("Nom").toString());
                                        java.util.Date utilDate = new java.util.Date(((Date)nextRow.getAttribute("DateNaissance")).getTime());
                                        
                                        //DateFormat dateFormat = new SimpleDateFormat("dd/MM/yyyy");
                                        String date_naissance = dateFormat.format(utilDate);
                                        setDate_naiss_bac(date_naissance);
                                        setLieu_naiss_bac(nextRow.getAttribute("LieuNaissance").toString());
                                }
                            }
                            
                        }

                        OperationBinding op_refresh = getBindings().getOperationBinding("refreshTableAutorise");
                        op_refresh.getParamsMap().put("id_parc_maq",  Long.parseLong(id_parc_maquette.getInputValue().toString()));
                        op_refresh.getParamsMap().put("id_annee",  Long.parseLong(getAnne_univers()));
                        op_refresh.execute();
                    }
                }
            }
        }

    return null;
    }
    
    public static String getRandomStr(int n) 
    {
        //choisissez un caractére au hasard à partir de cette chaîne
        String str = "ABCDEFGHIJKLMNPQRSTUVWXYZ0123456789"; 
    
        StringBuilder s = new StringBuilder(n); 
    
        for (int i = 0; i < n; i++) { 
            int index = (int)(str.length() * Math.random()); 
            s.append(str.charAt(index)); 
        } 
        return s.toString(); 
    }
    
    public static String getRandomNomber(int n) 
    {
        //choisissez un caractére au hasard à partir de cette chaîne
        String str = "123456789"; 
    
        StringBuilder s = new StringBuilder(n); 
    
        for (int i = 0; i < n; i++) { 
            int index = (int)(str.length() * Math.random()); 
            s.append(str.charAt(index)); 
        } 
        return s.toString(); 
    }

    public void refreshAfterInsert(){
        setPrenom_nouv("");
        setNom_nouv("");
        setDate_naiss_nouv("");
        setLieu_naiss_nouv("");  
        setCin_nouv("");
        setAdresse_nouv("");
        setEmail_pers_nouv("");
        setPortable_nouv("");
        
        //Le pays de residance de l'étudiant
        OperationBinding detpays = getBindings().getOperationBinding("getPaysPers");
        detpays.execute();

        //Nationalité de l'étudiant
        OperationBinding detpays_nation = getBindings().getOperationBinding("getPaysNationalite");
        detpays_nation.execute();
        
        // civilité de l'étudiant
        OperationBinding op_civilite = getBindings().getOperationBinding("getCivilitePers");
        op_civilite.execute();
    }


    @SuppressWarnings("unchecked")
    public void getRowPers(Row row_det_pers){
        
        setPrenom_nouv(row_det_pers.getAttribute("Prenoms").toString());
        setNom_nouv(row_det_pers.getAttribute("Nom").toString());
        java.util.Date utilDate = new java.util.Date(((Date)row_det_pers.getAttribute("DateNaissance")).getTime());
        
        DateFormat dateFormat = new SimpleDateFormat("dd/MM/yyyy");
        String date_naissance = dateFormat.format(utilDate);
        setDate_naiss_nouv(date_naissance);
        setLieu_naiss_nouv(row_det_pers.getAttribute("LieuNaissance").toString());
        
        setCin_nouv(row_det_pers.getAttribute("PieceIdentification").toString());
        
        setAdresse_nouv(row_det_pers.getAttribute("Adresse").toString());
        
        setEmail_pers_nouv(row_det_pers.getAttribute("EmailPersonnel").toString());
        setPortable_nouv(row_det_pers.getAttribute("Portable").toString());
        if(row_det_pers.getAttribute("Ine") == null)
            setIne_nouv("");
        else
            setIne_nouv(row_det_pers.getAttribute("Ine").toString());
        //Le pays de residance de l'étudiant
        OperationBinding detpays = getBindings().getOperationBinding("getPaysPers");
        detpays.getParamsMap().put("id_pays",  row_det_pers.getAttribute("IdPays"));
        detpays.execute();
    
        //Nationalité de l'étudiant
        OperationBinding detpays_nation = getBindings().getOperationBinding("getPaysNationalite");
        detpays_nation.getParamsMap().put("id_pays",  row_det_pers.getAttribute("IdPaysNationalite"));
        detpays_nation.execute();
        
        // civilité de l'étudiant
        OperationBinding op_civilite = getBindings().getOperationBinding("getCivilitePers");
        op_civilite.getParamsMap().put("id_civilite",  row_det_pers.getAttribute("IdCivilite"));
        op_civilite.execute();
        
        
        OperationBinding op_sexe = getBindings().getOperationBinding("getSexePers");
        if(row_det_pers.getAttribute("IdSexe") == null)
            op_sexe.getParamsMap().put("id_sexe",  0);
        else
            op_sexe.getParamsMap().put("id_sexe",  row_det_pers.getAttribute("IdSexe"));
        op_sexe.execute();
        
        OperationBinding is_nouv_bac = getBindings().getOperationBinding("getNouvBachelier");
        is_nouv_bac.getParamsMap().put("idpers",  Long.parseLong(row_det_pers.getAttribute("IdPersonne").toString()));
        is_nouv_bac.getParamsMap().put("id_annee",  Long.parseLong(getAnne_univers()));
        is_nouv_bac.execute();
        DCIteratorBinding iter_nouv_bac = (DCIteratorBinding)getBindings().get("NouveauxBacheliersIterator");
        Row rw_nouv_bac = iter_nouv_bac.getCurrentRow();
        if(rw_nouv_bac != null){
            System.out.println("good " +rw_nouv_bac.getAttribute("AnneBac").toString()+ " IdSerieBac "+rw_nouv_bac.getAttribute("IdSerieBac"));
            setBac_nouv(Integer.parseInt(rw_nouv_bac.getAttribute("AnneBac").toString()));
            //getSerieBachelier
            //SerieBacAttr
            OperationBinding op_serie_bac = getBindings().getOperationBinding("getSerieBachelier");
            op_serie_bac.getParamsMap().put("id_serie_bac",  rw_nouv_bac.getAttribute("IdSerieBac"));
            op_serie_bac.execute();
            DCIteratorBinding iter_serie_bac = (DCIteratorBinding)getBindings().get("SerieBacIterator");
            Row rw_op_serie_bac = iter_serie_bac.getCurrentRow();
            System.out.println("rw_op_serie_bac " +rw_op_serie_bac.getAttribute("Serie").toString());


            OperationBinding op_type_mention = getBindings().getOperationBinding("getTypeMent");
            op_type_mention.getParamsMap().put("id_type_mention",  rw_nouv_bac.getAttribute("IdTypeMention"));
            op_type_mention.execute();
            DCIteratorBinding iter_type_mention = (DCIteratorBinding)getBindings().get("TypeMentionIterator");
            Row rw_type_mention = iter_type_mention.getCurrentRow();
            System.out.println("IdTypeMention " +rw_type_mention.getAttribute("IdTypeMention").toString());            
            
            //getLyceeEtab id_lycee
            //getTypeMent id_type_mention
            OperationBinding op_lycee = getBindings().getOperationBinding("getLyceeEtab");
            op_lycee.getParamsMap().put("id_lycee",  rw_nouv_bac.getAttribute("IdLycee"));
            op_lycee.execute();
            
            DCIteratorBinding iter_lycee = (DCIteratorBinding)getBindings().get("LyceeIterator");
            Row rw_lycee = iter_lycee.getCurrentRow();
            System.out.println("IdTypeMention " +rw_lycee.getAttribute("IdLycee").toString());  
            
        }
        else{
            OperationBinding op_serie_bac = getBindings().getOperationBinding("getSerieBachelier");
            op_serie_bac.getParamsMap().put("id_serie_bac",  0);
            op_serie_bac.execute();
            OperationBinding op_type_mention = getBindings().getOperationBinding("getTypeMent");
            op_type_mention.getParamsMap().put("id_type_mention",  0);
            op_type_mention.execute();
            OperationBinding op_lycee = getBindings().getOperationBinding("getLyceeEtab");
            op_lycee.getParamsMap().put("id_lycee",  0);
            op_lycee.execute();
        }
        
        
    }
    @SuppressWarnings("unchecked")
    public Row infoGlobalForm(String id_niv_form_parc){
        OperationBinding op_info_form = getBindings().getOperationBinding("getInfoForm");
        op_info_form.getParamsMap().put("id_parc_maq",  Long.parseLong(id_niv_form_parc));
        //op_info_form.getParamsMap().put("id_annee",  Long.parseLong(id_annee));          
        op_info_form.execute();
        DCIteratorBinding iter_info = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("InscInfoGlobleFormIterator");
        return iter_info.getCurrentRow();
    }
    @SuppressWarnings("unchecked")
    public Row autoriserInsc(String id_pers,String id_niv_form_parc,String id_annee){
        OperationBinding op_auto_insc = getBindings().getOperationBinding("getInfoAutorise");
        op_auto_insc.getParamsMap().put("id_parc_maq",  Long.parseLong(id_niv_form_parc));
        op_auto_insc.getParamsMap().put("id_annee",  Long.parseLong(id_annee));  
        op_auto_insc.getParamsMap().put("id_pers",  Long.parseLong(id_pers));
        op_auto_insc.execute();
        DCIteratorBinding iter_info = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("PersDejaAutoriserROIterator");
        return iter_info.getCurrentRow();
    }
    
    @SuppressWarnings("unchecked")
    public void autoriser(String id_pers, String id_niv_form_parc,String id_annee,String nom,String prenom,String id_pays_nation){
        
        AttributeBinding id_type_form = (AttributeBinding) getBindings().getControlBinding("IdTypeFormationNivForm");
        AttributeBinding id_grade = (AttributeBinding) getBindings().getControlBinding("IdGradeNivForm");
        AttributeBinding niveau = (AttributeBinding) getBindings().getControlBinding("Niveau");
                
        //getDroitNiveauPays
        
        OperationBinding getDroitNiveauPays = getBindings().getOperationBinding("getDroitNiveauPays");
        getDroitNiveauPays.getParamsMap().put("id_niveau",  Long.parseLong(niveau.getInputValue().toString())); 
        getDroitNiveauPays.getParamsMap().put("id_pays_nation",  Long.parseLong(id_pays_nation));
        getDroitNiveauPays.execute(); 
        DCIteratorBinding iter_droit_niv = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("DroitNiveauPaysROIterator");
        Row row_droit_niv_pays = iter_droit_niv.getCurrentRow();

        OperationBinding detpers = getBindings().getOperationBinding("getDetailPers");
        detpers.getParamsMap().put("idpers_var",  Long.parseLong(id_pers));
        detpers.execute();
        
        DCIteratorBinding iter_det_pers = (DCIteratorBinding)getBindings().get("PersonnesIterator");
            //Create RowSetIterato iterate over viewObject
        RowSetIterator rsi_det_pers = iter_det_pers.getViewObject().createRowSetIterator(null);
        Row row_det_pers = rsi_det_pers.first();

        // regarde le niv de form Niveau

        //L'autorisation pour le niv form (1) concerne les nouveaux bacheliers
        if(Integer.parseInt(niveau.getInputValue().toString()) == 1){            
            OperationBinding is_nouv_bac_ucad = BindingContext.getCurrent().getCurrentBindingsEntry().getOperationBinding("isNouvBac");
            is_nouv_bac_ucad.getParamsMap().put("id_pers",  Long.parseLong(id_pers));               
            Integer res_is_nouv_bac_ucad = (Integer)is_nouv_bac_ucad.execute();            
            //si la personne est un bachelier orienté à l'ucad
            if(res_is_nouv_bac_ucad > 0){
                //row_droit_niv_pays
                if (row_droit_niv_pays == null) {
                    FacesMessage msg = new FacesMessage( " Impossible de d'inscrire provisoirement parce que le droit d'inscription n'est pas renseigné ! ");
                    msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                    FacesContext.getCurrentInstance().addMessage(null, msg);                   
                    getRowPers(row_det_pers);                   
                }
                else{
                    List les_semestre = semestreNiv(Integer.parseInt(niveau.getInputValue().toString()));
                    
                    //enregistrement du nouv bachelier comme un étudaint
                    AttributeBinding util_insert_etud = (AttributeBinding) getBindings().getControlBinding("UtiCreeEtud");
                    AttributeBinding id_pers_etud = (AttributeBinding) getBindings().getControlBinding("IdPersonneEtud");
                    AttributeBinding numero_etud = (AttributeBinding) getBindings().getControlBinding("Numero");
                    
                    OperationBinding op_insert_etud = getBindings().getOperationBinding("CreateInsertEtudiant");
                    Object result = op_insert_etud.execute();
                    if (!op_insert_etud.getErrors().isEmpty()) {
                        return ;
                    }
                    else{
                        //getAnneeEnCours
                        OperationBinding getAnneeEnCours = getBindings().getOperationBinding("getAnneeEnCours");
                        getAnneeEnCours.getParamsMap().put("id_annee",  Long.parseLong(getAnne_univers()));
                        getAnneeEnCours.execute();
                        DCIteratorBinding iter_annee_cours = (DCIteratorBinding)getBindings().get("AnneeUniversEnCoursROIterator");
                        String annee_cours = iter_annee_cours.getCurrentRow().getAttribute("AnneeCours").toString();
                        
                        util_insert_etud.setInputValue(Long.parseLong(getUtilisateur()));
                        id_pers_etud.setInputValue(Long.parseLong(id_pers));
                        String chaine_aleatoire = getRandomStr(3);
                        String nomb_alea = getRandomNomber(1);
                        numero_etud.setInputValue(annee_cours+"0"+nomb_alea+chaine_aleatoire);          // Exemple 200903K3C
                        
                        OperationBinding op_insert_etud_commit = getBindings().getOperationBinding("Commit");
                        Object result_commit = op_insert_etud_commit.execute();
                        if (!op_insert_etud_commit.getErrors().isEmpty()) {
                            return;
                        }                       
                        else{
                            AttributeBinding id_etudiant = (AttributeBinding) getBindings().getControlBinding("IdEtudiant");
                            
                            AttributeBinding idTypeFormation = (AttributeBinding) getBindings().getControlBinding("IdTypeFormationInscAdmin");
                            AttributeBinding id_annee_insc_admin = (AttributeBinding) getBindings().getControlBinding("IdAnneesUniversInscAdmin");
                            AttributeBinding idetud = (AttributeBinding) getBindings().getControlBinding("IdEtudiantInscAdmin");
                            AttributeBinding idGrade = (AttributeBinding) getBindings().getControlBinding("IdGradeInscAdmin");
                            AttributeBinding util_insert_admin = (AttributeBinding) getBindings().getControlBinding("UtiCreeInscAdmin");
                            
                            
                            OperationBinding op_insc_admin = getBindings().getOperationBinding("CreateInsertInscAdmin");
                            Object result_op_insc_admin = op_insc_admin.execute();
                            if (!op_insc_admin.getErrors().isEmpty()) {
                                return ;
                            }
                            else{
                                util_insert_admin.setInputValue(Long.parseLong(getUtilisateur()));
                                idTypeFormation.setInputValue(Long.parseLong(id_type_form.getInputValue().toString()));
                                id_annee_insc_admin.setInputValue(Long.parseLong(id_annee));
                                idetud.setInputValue(Long.parseLong(id_etudiant.getInputValue().toString()));
                                idGrade.setInputValue(Long.parseLong(id_grade.getInputValue().toString()));
                                
                                OperationBinding op_insert_admin_commit = getBindings().getOperationBinding("Commit");
                                Object result_insert_admin_commit = op_insert_admin_commit.execute();
                                if (!op_insert_admin_commit.getErrors().isEmpty()) {
                                    return;
                                }                               
                                else{
                                    AttributeBinding id_insc_admin = (AttributeBinding) getBindings().getControlBinding("IdInscriptionAdmin");
                                    
                                    //les attributs qui seront modifier lors de l'insc
                                    AttributeBinding id_insc_admin_ped = (AttributeBinding) getBindings().getControlBinding("IdInscriptionAdminPed");
                                    AttributeBinding id_HorairesTd = (AttributeBinding) getBindings().getControlBinding("IdHorairesTd");
                                    AttributeBinding id_Statut = (AttributeBinding) getBindings().getControlBinding("IdStatut");
                                    AttributeBinding id_Option = (AttributeBinding) getBindings().getControlBinding("IdOption");
                                    AttributeBinding id_Bourse = (AttributeBinding) getBindings().getControlBinding("IdBourse");
                                    AttributeBinding id_Cohorte = (AttributeBinding) getBindings().getControlBinding("IdCohorte");
                                    AttributeBinding id_TypeConvention = (AttributeBinding) getBindings().getControlBinding("IdTypeConvention");
                                    AttributeBinding id_Operateur = (AttributeBinding) getBindings().getControlBinding("IdOperateur");
                                    AttributeBinding derniere_insc = (AttributeBinding) getBindings().getControlBinding("DernierInscription");
                                    
                                    AttributeBinding id_parc_maq_annee = (AttributeBinding) getBindings().getControlBinding("IdParcoursMaquetAnneePed");
                                    AttributeBinding nb_insc = (AttributeBinding) getBindings().getControlBinding("NbInsc");
                                    AttributeBinding util_permet_double_insc = (AttributeBinding) getBindings().getControlBinding("UtiPermetDoublInsPed");
                                    AttributeBinding id_etat_insc = (AttributeBinding) getBindings().getControlBinding("EtatInscrEtatInscrId");
                                    AttributeBinding tarif = (AttributeBinding) getBindings().getControlBinding("Tarif");
                                    AttributeBinding orde_insc = (AttributeBinding) getBindings().getControlBinding("OrdreInscription");
                                    AttributeBinding utilisateur_cree = (AttributeBinding) getBindings().getControlBinding("UtiCreeInscPed");

                                    AttributeBinding cout_formation = (AttributeBinding) getBindings().getControlBinding("CoutFormation");
                                    AttributeBinding droit_ins_adm = (AttributeBinding) getBindings().getControlBinding("DroitInsAdm");
                                    AttributeBinding droit_ins_ped = (AttributeBinding) getBindings().getControlBinding("DroitInsPed");
                                    
                                    OperationBinding op_insc_ped = getBindings().getOperationBinding("CreateInsertInscPed");
                                    Object result_op_insc_ped = op_insc_ped.execute();
                                    if (!op_insc_ped.getErrors().isEmpty()) {
                                        return ;
                                    }
                                    else{
                                        // les frais d'inscription
                                        Integer droit_insc_admin = 0;
                                        Integer droit_insc_ped = 0;
                                        if(row_droit_niv_pays.getAttribute("DroitInsAdm") != null && row_droit_niv_pays.getAttribute("DroitInsPed") == null){
                                            droit_insc_admin = Integer.parseInt( row_droit_niv_pays.getAttribute("DroitInsAdm").toString());
                                            droit_ins_adm.setInputValue(droit_insc_admin);
                                            droit_ins_ped.setInputValue(row_droit_niv_pays.getAttribute("DroitInsPed"));
                                            cout_formation.setInputValue( 0 + droit_insc_admin);
                                        }
                                        else{
                                            if(row_droit_niv_pays.getAttribute("DroitInsPed") != null && row_droit_niv_pays.getAttribute("DroitInsAdm") == null){
                                                droit_insc_ped = Integer.parseInt( row_droit_niv_pays.getAttribute("DroitInsPed").toString());
                                                droit_ins_ped.setInputValue(droit_insc_ped);
                                                droit_ins_adm.setInputValue(row_droit_niv_pays.getAttribute("DroitInsAdm"));
                                                cout_formation.setInputValue( 0 + droit_insc_ped);
                                            }
                                            else{
                                                if(row_droit_niv_pays.getAttribute("DroitInsPed") == null && row_droit_niv_pays.getAttribute("DroitInsAdm") == null){
                                                    droit_ins_ped.setInputValue(row_droit_niv_pays.getAttribute("DroitInsPed"));
                                                    droit_ins_adm.setInputValue(row_droit_niv_pays.getAttribute("DroitInsAdm"));
                                                    cout_formation.setInputValue(null);
                                                }
                                                else{
                                                    droit_insc_admin = Integer.parseInt( row_droit_niv_pays.getAttribute("DroitInsAdm").toString());
                                                    droit_insc_ped = Integer.parseInt( row_droit_niv_pays.getAttribute("DroitInsPed").toString());
                                                    droit_ins_ped.setInputValue(row_droit_niv_pays.getAttribute("DroitInsPed"));
                                                    droit_ins_adm.setInputValue(row_droit_niv_pays.getAttribute("DroitInsAdm"));
                                                    cout_formation.setInputValue(droit_insc_admin + droit_insc_ped);
                                                }
                                            }
                                        }
                                        id_insc_admin_ped.setInputValue(Long.parseLong(id_insc_admin.getInputValue().toString()));
                                        id_HorairesTd.setInputValue(Long.parseLong("7"));
                                        id_Statut.setInputValue(Long.parseLong("1"));
                                        id_Option.setInputValue(Long.parseLong("1"));
                                        id_Bourse.setInputValue(Long.parseLong("1"));
                                        id_Cohorte.setInputValue(Long.parseLong("1"));
                                        id_TypeConvention.setInputValue(Long.parseLong("1"));
                                        id_Operateur.setInputValue(Long.parseLong("1"));
                                        derniere_insc.setInputValue(Long.parseLong("0")); //0 : un nouv bachelier
                                        id_parc_maq_annee.setInputValue(Long.parseLong(id_niv_form_parc));
                                        nb_insc.setInputValue(Long.parseLong("1"));
                                        util_permet_double_insc.setInputValue(Long.parseLong(getUtilisateur())); //utilisateur connecté ou un autre
                                        id_etat_insc.setInputValue(Long.parseLong("21")); // etat provisoire
                                        utilisateur_cree.setInputValue(Long.parseLong(getUtilisateur()));
                                        
                                        OperationBinding op_insert_ped_commit = getBindings().getOperationBinding("Commit");
                                        Object result_insert_ped_commit = op_insert_ped_commit.execute();
                                        if (!op_insert_ped_commit.getErrors().isEmpty()) {
                                            return;
                                        }                               
                                        else{
                                            FacesMessage msg = new FacesMessage( "L'étudiant du nom & prénom : "+nom+" "+prenom+"   ("+numero+" ) est inscrit pédagogiquement ");
                                            msg.setSeverity(FacesMessage.SEVERITY_INFO);
                                            FacesContext.getCurrentInstance().addMessage(null, msg); 
                                        }
                                    }
                                }
                            }                                                                    
                        }                        
                    }                    
                } 
            }
            //la personne est un bachelier, mais n'est pas orienté à l'ucad (dans ce cas il faut une autorisation)
            else{
                insertAutorisation(id_pers, id_niv_form_parc,id_annee," La personne du nom & prénom : "+nom+"  "+prenom+" est autorisée à s'inscrire"," NB: Un nouveau Bachelier qui n'est pas orienté à L'ucad (Par Equivalence)");
            }
        }
        //L'autorisation pour le niv form different de (1) concerne les primos entrant
        else{
            insertAutorisation(id_pers, id_niv_form_parc,id_annee," La personne du nom & prénom : "+nom+"  "+prenom+" est autorisée à s'inscrire"," NB: Un primo entrant à L'ucad (Par Equivalence)");
        }
    }

    @SuppressWarnings("oracle.jdeveloper.java.unchecked-conversion-or-cast")
    public void autoriserEtudiant(String id_pers, String id_niv_form_parc,String id_annee,String nom,String prenom){

        AttributeBinding id_type_form = (AttributeBinding) getBindings().getControlBinding("IdTypeFormationNivForm");
        AttributeBinding id_grade = (AttributeBinding) getBindings().getControlBinding("IdGradeNivForm");
        //AttributeBinding numero_etud = (AttributeBinding) getBindings().getControlBinding("Numero");
        AttributeBinding niveau = (AttributeBinding) getBindings().getControlBinding("Niveau");
        Row row_global_form = infoGlobalForm(id_niv_form_parc);
        
        OperationBinding detpers = getBindings().getOperationBinding("getDetailPers");
        detpers.getParamsMap().put("idpers_var",  Long.parseLong(id_pers));
        detpers.execute();
        
        DCIteratorBinding iter_det_pers = (DCIteratorBinding)getBindings().get("PersonnesIterator");
            //Create RowSetIterato iterate over viewObject
        RowSetIterator rsi_det_pers = iter_det_pers.getViewObject().createRowSetIterator(null);
        Row row_det_pers = rsi_det_pers.first();
        
        //getEtudiant
        OperationBinding getEtud = getBindings().getOperationBinding("getEtudiant");
        getEtud.getParamsMap().put("idpers",  Long.parseLong(id_pers));
        getEtud.execute();
        DCIteratorBinding iter_etud = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("EtudiantsIterator");
        Row row_etud = iter_etud.getCurrentRow();
        String id_etud = row_etud.getAttribute("IdEtudiant").toString();
        System.out.println("id_etud "+id_etud);
        
        if (row_global_form == null) {
            FacesMessage msg = new FacesMessage( " Pas de Formation ");
            msg.setSeverity(FacesMessage.SEVERITY_ERROR);
            FacesContext.getCurrentInstance().addMessage(null, msg);
            return ;
        }
        else{
            //prendre en compte le niveau 1, ainsi que les autres niveaux
            Integer niv_inf = 1;
            if((Integer.parseInt(niveau.getInputValue().toString()) -1) > 0)
                niv_inf = (Integer.parseInt(niveau.getInputValue().toString()) -1);
            //Son inscription de l'année passée
            OperationBinding op_annee_passee = getBindings().getOperationBinding("getAnneeUniversPassee");
            op_annee_passee.getParamsMap().put("id_annee",  Long.parseLong(getAnne_univers()));
            op_annee_passee.execute();
            DCIteratorBinding iter_annee_passee = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("AnneeUniversPasseeROIterator");
            Row row_set_annee_passee = iter_annee_passee.getCurrentRow();

            System.out.println("row_set_annee_passee "+row_set_annee_passee+" lib annee "+row_set_annee_passee.getAttribute("IdLibLongPasse")+"id_annee" +row_set_annee_passee.getAttribute("IdAnneePasse"));
            //inscription du niveau inferieur de l'année passée
            OperationBinding op_insc_annee_passee = getBindings().getOperationBinding("getInscAnneePassee");
            op_insc_annee_passee.getParamsMap().put("id_annee",  row_set_annee_passee.getAttribute("IdAnneePasse"));
            op_insc_annee_passee.getParamsMap().put("idpers",  Long.parseLong(id_pers));
            op_insc_annee_passee.getParamsMap().put("niveau_form",  niv_inf);
            op_insc_annee_passee.execute();
            DCIteratorBinding iter_insc_annee_passee = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("InsChangementCycleROIterator");
            Row row_insc_annee_passee = iter_insc_annee_passee.getCurrentRow();
            System.out.println("row_insc_annee_passee "+ row_insc_annee_passee);
            
            OperationBinding op_annee_en_cours = getBindings().getOperationBinding("getAnneeEnCours");
            op_annee_en_cours.getParamsMap().put("id_annee",  Long.parseLong(getAnne_univers()));
            op_annee_en_cours.execute();
            DCIteratorBinding iter_annee_en_cours = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("AnneeUniversEnCoursROIterator");
            Row row_set_annee_en_cours = iter_annee_en_cours.getCurrentRow();
            
            // autorisation pour le niveau master ou le niveau doctorat
            if((Integer.parseInt(niveau.getInputValue().toString()) == 4)||(Integer.parseInt(niveau.getInputValue().toString()) == 6)){
                //recuperer son resultat en licence
                // avec id_cycle 22 (premier cycle)
                //id_cycle 81 (deuxieme cycle)
                OperationBinding op_last_insc = getBindings().getOperationBinding("getLastInsc");
                op_last_insc.getParamsMap().put("idpers",  Long.parseLong(id_pers));
                op_last_insc.execute();
                DCIteratorBinding iter_op_last_insc = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("InscAncienneROIterator");
                Row row_op_last_insce = iter_op_last_insc.getCurrentRow();
                if(row_op_last_insce == null){
                    insertAutorisation(id_pers, id_niv_form_parc,id_annee," L'étudiant du nom & prénom : "+nom+"  "+prenom+" est autorisée à s'inscrire en "+row_global_form.getAttribute("LibNivForm"), "NB: Autorisé par Changement de cycle (Par equivalence), Primo-entrant");
                    System.out.println("row_primo ");
                }
                else{
                    //inscription
                    OperationBinding op_getNbreInsPed = getBindings().getOperationBinding("getNbreInsPed");
                    op_getNbreInsPed.getParamsMap().put("id_etud",  id_etud);
                    op_getNbreInsPed.getParamsMap().put("id_annee",  row_op_last_insce.getAttribute("IdAnneesUnivers"));
                    Integer nbr_insc_ped_annee_passe = (Integer)op_getNbreInsPed.execute();
                    
                    if(nbr_insc_ped_annee_passe == 2){
                        //Row liste_insc_ped = getListeInscPed(id_etud, id_annee);
                        OperationBinding op_getNiveau_ant = getBindings().getOperationBinding("getListeInscPed");
                        op_getNiveau_ant.getParamsMap().put("id_etud",  id_etud);
                        op_getNiveau_ant.getParamsMap().put("id_annee",  row_op_last_insce.getAttribute("IdAnneesUnivers"));
                        op_getNiveau_ant.execute();
                        /*DCIteratorBinding iter_op_res_ann = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("LesInscPedROIterator");
                        return  iter_op_res_ann.getCurrentRow();*/
                        DCIteratorBinding iter_liste = (DCIteratorBinding)getBindings().get("LesInscPedROIterator");
                            //Create RowSetIterato iterate over viewObject
                        RowSetIterator rsi_iter_liste = iter_liste.getViewObject().createRowSetIterator(null);
                        Row row_insc_ped_niv_inf = rsi_iter_liste.first();
                        Row row_insc_ped_niv_sup = rsi_iter_liste.last();
                        
                        inscriptionDoubleInscPed(row_insc_ped_niv_inf.getAttribute("IdInscriptionPedagogique").toString(), row_insc_ped_niv_sup.getAttribute("IdInscriptionPedagogique").toString(), Integer.parseInt(niveau.getInputValue().toString()), "id_annee_sup",row_global_form,id_pers, id_etud, id_niv_form_parc, row_det_pers);
                        System.out.println("row_insc_ped_niv_sup "+row_insc_ped_niv_sup.getAttribute("IdInscriptionPedagogique"));
                        System.out.println("row_insc_ped_niv_inf "+row_insc_ped_niv_inf.getAttribute("IdInscriptionPedagogique"));
                        
                    }
                    else{
                    if(nbr_insc_ped_annee_passe == 1){
                    //le cycle 2 : Master
                    if(Integer.parseInt(niveau.getInputValue().toString()) == 4){
                        //if(Integer.parseInt(row_op_last_insce.getAttribute("Niveau").toString()) <= 3){
                        String last_annee = row_op_last_insce.getAttribute("LibAnnee").toString();
                        String lib_annee_cours = row_set_annee_en_cours.getAttribute("LibelleLong").toString();
                        if(Integer.parseInt(row_op_last_insce.getAttribute("Niveau").toString()) == 1 && anneePossible(last_annee,lib_annee_cours,3) > 0){
                            insertAutorisation(id_pers, id_niv_form_parc,id_annee," L'étudiant du nom & prénom : "+nom+"  "+prenom+" est autorisée à s'inscrire en "+row_global_form.getAttribute("LibNivForm"), "NB: Autorisé par Changement de cycle (Par equivalence), ");
                            System.out.println("L'étudiant du nom & prénom : "+nom+"  "+prenom+" : dernier niveau de formation inscrit :"+row_op_last_insce.getAttribute("LibNivForm")+" pour l'année universitaire : "+row_op_last_insce.getAttribute("LibAnnee"));
                        }
                        else{
                            if(Integer.parseInt(row_op_last_insce.getAttribute("Niveau").toString()) == 2 && anneePossible(last_annee,lib_annee_cours,2) > 0){
                                insertAutorisation(id_pers, id_niv_form_parc,id_annee," L'étudiant du nom & prénom : "+nom+"  "+prenom+" est autorisée à s'inscrire en "+row_global_form.getAttribute("LibNivForm"), "NB: Autorisé par Changement de cycle (Par equivalence), ");
                                System.out.println("L'étudiant du nom & prénom : "+nom+"  "+prenom+" : dernier niveau de formation inscrit :"+row_op_last_insce.getAttribute("LibNivForm")+" pour l'année universitaire : "+row_op_last_insce.getAttribute("LibAnnee"));
                            }
                            else{
                                if(Integer.parseInt(row_op_last_insce.getAttribute("Niveau").toString()) == 3 && anneePossible(last_annee,lib_annee_cours,1) > 0){
                                    // inscription du niveau 1
                                    //getInscAncienneNiv1
                                    OperationBinding op_last_insc_niv1 = getBindings().getOperationBinding("getInscAncienneNiv1");
                                    op_last_insc_niv1.getParamsMap().put("idpers",  Long.parseLong(id_pers));
                                    op_last_insc_niv1.getParamsMap().put("niv",  1);
                                    op_last_insc_niv1.execute();
                                    DCIteratorBinding iter_op_last_insc_niv1 = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("InscAncienneNiv1Iterator");
                                    Row row_op_last_insc_niv1 = iter_op_last_insc_niv1.getCurrentRow();
                                    
                                    //getInscAncienneNiv2
                                    OperationBinding op_last_insc_niv2 = getBindings().getOperationBinding("getInscAncienneNiv2");
                                    op_last_insc_niv2.getParamsMap().put("idpers",  Long.parseLong(id_pers));
                                    op_last_insc_niv2.getParamsMap().put("niv",  2);
                                    op_last_insc_niv2.execute();
                                    DCIteratorBinding iter_op_last_insc_niv2 = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("InscAncienneNiv2Iterator");
                                    Row row_op_last_insc_niv2 = iter_op_last_insc_niv2.getCurrentRow();
                                    //recuperer le resultat du niveau 3
                                    OperationBinding op_res_ann = getBindings().getOperationBinding("getResultatAnnuel");
                                    op_res_ann.getParamsMap().put("id_annee",  row_op_last_insce.getAttribute("IdAnneesUnivers"));
                                    op_res_ann.getParamsMap().put("idpers",  Long.parseLong(id_pers));
                                    op_res_ann.execute();
                                    DCIteratorBinding iter_op_res_ann = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("ResultatAnnuelROIterator");
                                    Row row_op_res_ann_niv3 = iter_op_res_ann.getCurrentRow();
                                    //possedant pas d'inscription en L1 et en L2
                                    if((row_op_last_insc_niv1 == null && row_op_last_insc_niv2 == null) || (row_op_last_insc_niv1 != null && row_op_last_insc_niv2 == null) || (row_op_last_insc_niv1 == null && row_op_last_insc_niv2 != null)){
    
                                        // Pas de resultat pour sa derniere inscription
                                        if(row_op_res_ann_niv3 == null){
                                            FacesMessage msg = new FacesMessage(" Impossible d'autoriser l'étudiant "+ nom+" "+prenom+" à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
                                            msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                            FacesContext.getCurrentInstance().addMessage(null, msg);
                                            FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Veuillez saisir le resultat de la formation : "+row_op_last_insce.getAttribute("LibNivForm")+" de l'année universitaire : "+row_op_last_insce.getAttribute("LibAnnee")));
                                            getRowPers(row_det_pers);
                                        }
                                        else{
                                            if( Integer.parseInt(row_op_res_ann_niv3.getAttribute("Resultat").toString()) == 1 ){
                                                insertAutorisation(id_pers, id_niv_form_parc,id_annee," L'étudiant du nom & prénom : "+nom+"  "+prenom+" est autorisée à s'inscrire en "+row_global_form.getAttribute("LibNivForm"), "NB: Autorisé par Changement de cycle ");                         
                                            }
                                            else{
                                                if(Integer.parseInt(row_op_last_insce.getAttribute("IdAnneesUnivers").toString()) == Integer.parseInt(row_set_annee_passee.getAttribute("IdAnneePasse").toString())){
                                                    FacesMessage msg = new FacesMessage(" Impossible d'autoriser l'étudiant "+ nom+" "+prenom+" à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
                                                    msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                                    FacesContext.getCurrentInstance().addMessage(null, msg);
                                                    
                                                    FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Le dernier niveau de formation ( "+row_op_last_insce.getAttribute("LibNivForm")+" ) inscrit pour l'année universitaire ("+row_op_last_insce.getAttribute("LibAnnee")+" ) n'est pas encore validé"));
                                                    FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" NB : Redoublant ( "+row_op_last_insce.getAttribute("LibNivForm")+" ) "));
                                                    getRowPers(row_det_pers);
                                                }
                                                else
                                                    insertAutorisation(id_pers, id_niv_form_parc,id_annee," L'étudiant du nom & prénom : "+nom+"  "+prenom+" est autorisée à s'inscrire en "+row_global_form.getAttribute("LibNivForm"), "NB: Autorisé par Changement de cycle (Par equivalence), ");
                                            }
                                        }
                                    }
                                    else{
                                        if(row_op_last_insc_niv1 != null && row_op_last_insc_niv2 != null){
                                            //recuperer le resultat du niveau 1
                                            OperationBinding op_res_ann_niv1 = getBindings().getOperationBinding("getResultatAnnuel");
                                            op_res_ann_niv1.getParamsMap().put("id_annee",  row_op_last_insc_niv1.getAttribute("IdAnneesUnivers"));
                                            op_res_ann_niv1.getParamsMap().put("idpers",  Long.parseLong(id_pers));
                                            op_res_ann_niv1.execute();
                                            DCIteratorBinding iter_op_res_ann_niv1 = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("ResultatAnnuelROIterator");
                                            Row row_op_res_ann_niv1 = iter_op_res_ann_niv1.getCurrentRow();
                                            
                                            //recuperer le resultat du niveau 1
                                            OperationBinding op_res_ann_niv2 = getBindings().getOperationBinding("getResultatAnnuel");
                                            op_res_ann_niv2.getParamsMap().put("id_annee",  row_op_last_insc_niv2.getAttribute("IdAnneesUnivers"));
                                            op_res_ann_niv2.getParamsMap().put("idpers",  Long.parseLong(id_pers));
                                            op_res_ann_niv2.execute();
                                            DCIteratorBinding iter_op_res_ann_niv2 = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("ResultatAnnuelROIterator");
                                            Row row_op_res_ann_niv2 = iter_op_res_ann_niv2.getCurrentRow();
                                            System.out.println("row_op_res_ann_niv1"+row_op_res_ann_niv1);
                                            System.out.println("row_op_res_ann_niv2"+row_op_res_ann_niv2);
                                            if(row_op_res_ann_niv1 == null || row_op_res_ann_niv2 == null || row_op_res_ann_niv3 == null){
                                                FacesMessage msg = new FacesMessage(" Impossible d'autoriser l'étudiant "+ nom+" "+prenom+" à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
                                                msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                                FacesContext.getCurrentInstance().addMessage(null, msg);
                                                if(row_op_res_ann_niv3 == null)
                                                    FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Veuillez saisir le resultat de la formation : "+row_op_last_insce.getAttribute("LibNivForm")+" de l'année universitaire : "+row_op_last_insce.getAttribute("LibAnnee")));
                                                if(row_op_res_ann_niv2 == null)
                                                    FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Veuillez saisir le resultat de la formation : "+row_op_last_insc_niv2.getAttribute("LibNivForm")+" de l'année universitaire : "+row_op_last_insc_niv2.getAttribute("LibAnnee")));
                                                if(row_op_res_ann_niv1 == null)
                                                    FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Veuillez saisir le resultat de la formation : "+row_op_res_ann_niv1.getAttribute("LibNivForm")+" de l'année universitaire : "+row_op_last_insc_niv1.getAttribute("LibAnnee")));
                                                
                                                getRowPers(row_det_pers);
                                            }
                                            else{
                                                if(Integer.parseInt(row_op_res_ann_niv1.getAttribute("Resultat").toString()) != 1  || Integer.parseInt(row_op_res_ann_niv2.getAttribute("Resultat").toString()) != 1 || Integer.parseInt(row_op_res_ann_niv3.getAttribute("Resultat").toString()) != 1){
                                                    FacesMessage msg = new FacesMessage(" Impossible d'autoriser l'étudiant "+ nom+" "+prenom+" à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
                                                    msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                                    FacesContext.getCurrentInstance().addMessage(null, msg);
                                                    if(row_op_res_ann_niv3 == null)
                                                        FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Le niveau de formation : "+row_op_last_insce.getAttribute("LibNivForm")+" de l'année universitaire : "+row_op_last_insce.getAttribute("LibAnnee")+" n'est pas encore validé"));
                                                    if(row_op_res_ann_niv2 == null)
                                                        FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Le niveau de formation : "+row_op_last_insc_niv2.getAttribute("LibNivForm")+" de l'année universitaire : "+row_op_last_insc_niv2.getAttribute("LibAnnee")+" n'est pas encore validé"));
                                                    if(row_op_res_ann_niv1 == null)
                                                        FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Le niveau de formation : "+row_op_last_insc_niv1.getAttribute("LibNivForm")+" de l'année universitaire : "+row_op_last_insc_niv1.getAttribute("LibAnnee")+" n'est pas encore validé"));
                                                    
                                                    getRowPers(row_det_pers);
                                                }
                                                else{
                                                    if(Integer.parseInt(row_op_res_ann_niv1.getAttribute("Resultat").toString()) == 1  && Integer.parseInt(row_op_res_ann_niv2.getAttribute("Resultat").toString()) == 1 && Integer.parseInt(row_op_res_ann_niv3.getAttribute("Resultat").toString()) == 1){
                                                        inscChangementResultatCycle(id_pers, id_niv_form_parc,id_annee,row_op_last_insce.getAttribute("LibNivForm").toString());
    
                                                    }
                                                }
                                            }
                                        }
                                    }

                                }
                                else{
                                    FacesMessage msg = new FacesMessage(" Impossible d'autoriser l'étudiant "+ nom+" "+prenom+" à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
                                    msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                    FacesContext.getCurrentInstance().addMessage(null, msg);
                                    FacesContext.getCurrentInstance().addMessage(null, new FacesMessage("Le dernier niveau de formation inscrit :"+row_op_last_insce.getAttribute("LibNivForm")+" pour l'année universitaire : "+row_op_last_insce.getAttribute("LibAnnee")));
                                    getRowPers(row_det_pers);
                                }
                            }
                        }

                    }
                    //cycle 3 : Doctorat
                    else{
                        if(Integer.parseInt(niveau.getInputValue().toString()) == 6){
                            String last_annee = row_op_last_insce.getAttribute("LibAnnee").toString();
                            String lib_annee_cours = row_set_annee_en_cours.getAttribute("LibelleLong").toString();
                            if(Integer.parseInt(row_op_last_insce.getAttribute("Niveau").toString()) == 1 && anneePossible(last_annee,lib_annee_cours,5) > 0){
                                insertAutorisation(id_pers, id_niv_form_parc,id_annee," L'étudiant du nom & prénom : "+nom+"  "+prenom+" est autorisée à s'inscrire en "+row_global_form.getAttribute("LibNivForm"), "NB: Autorisé par Changement de cycle (Par equivalence), ");
                                System.out.println("L'étudiant du nom & prénom : "+nom+"  "+prenom+" : dernier niveau de formation inscrit :"+row_op_last_insce.getAttribute("LibNivForm")+" pour l'année universitaire : "+row_op_last_insce.getAttribute("LibAnnee"));
                            }
                            else{
                                if(Integer.parseInt(row_op_last_insce.getAttribute("Niveau").toString()) == 2 && anneePossible(last_annee,lib_annee_cours,4) > 0){
                                    insertAutorisation(id_pers, id_niv_form_parc,id_annee," L'étudiant du nom & prénom : "+nom+"  "+prenom+" est autorisée à s'inscrire en "+row_global_form.getAttribute("LibNivForm"), "NB: Autorisé par Changement de cycle (Par equivalence), ");
                                    System.out.println("L'étudiant du nom & prénom : "+nom+"  "+prenom+" : dernier niveau de formation inscrit :"+row_op_last_insce.getAttribute("LibNivForm")+" pour l'année universitaire : "+row_op_last_insce.getAttribute("LibAnnee"));
                                }
                                else{
                                    if(Integer.parseInt(row_op_last_insce.getAttribute("Niveau").toString()) == 3 && anneePossible(last_annee,lib_annee_cours,3) > 0){
                                        // inscription du niveau 3
                                        insertAutorisation(id_pers, id_niv_form_parc,id_annee," L'étudiant du nom & prénom : "+nom+"  "+prenom+" est autorisée à s'inscrire en "+row_global_form.getAttribute("LibNivForm"), "NB: Autorisé par Changement de cycle (Par equivalence), ");
                                        System.out.println("L'étudiant du nom & prénom : "+nom+"  "+prenom+" : dernier niveau de formation inscrit :"+row_op_last_insce.getAttribute("LibNivForm")+" pour l'année universitaire : "+row_op_last_insce.getAttribute("LibAnnee"));
                                    }
                                    else{
                                        if(Integer.parseInt(row_op_last_insce.getAttribute("Niveau").toString()) == 4 && anneePossible(last_annee,lib_annee_cours,2) > 0){
                                            insertAutorisation(id_pers, id_niv_form_parc,id_annee," L'étudiant du nom & prénom : "+nom+"  "+prenom+" est autorisée à s'inscrire en "+row_global_form.getAttribute("LibNivForm"), "NB: Autorisé par Changement de cycle (Par equivalence), ");
                                            System.out.println("L'étudiant du nom & prénom : "+nom+"  "+prenom+" : dernier niveau de formation inscrit :"+row_op_last_insce.getAttribute("LibNivForm")+" pour l'année universitaire : "+row_op_last_insce.getAttribute("LibAnnee"));
                                        }
                                        else{
                                            if(Integer.parseInt(row_op_last_insce.getAttribute("Niveau").toString()) == 5 && anneePossible(last_annee,lib_annee_cours,1) > 0){
                                                // inscription du niveau 4
                                                OperationBinding op_last_insc_niv4 = getBindings().getOperationBinding("getInscAncienneNiv1");
                                                op_last_insc_niv4.getParamsMap().put("idpers",  Long.parseLong(id_pers));
                                                op_last_insc_niv4.getParamsMap().put("niv",  4);
                                                op_last_insc_niv4.execute();
                                                DCIteratorBinding iter_op_last_insc_niv4 = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("InscAncienneNiv1Iterator");
                                                Row row_op_last_insc_niv4 = iter_op_last_insc_niv4.getCurrentRow();
                                                
                                                //recuperer le resultat du niveau 5
                                                OperationBinding op_res_ann = getBindings().getOperationBinding("getResultatAnnuel");
                                                op_res_ann.getParamsMap().put("id_annee",  row_op_last_insce.getAttribute("IdAnneesUnivers"));
                                                op_res_ann.getParamsMap().put("idpers",  Long.parseLong(id_pers));
                                                op_res_ann.execute();
                                                DCIteratorBinding iter_op_res_ann = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("ResultatAnnuelROIterator");
                                                Row row_op_res_ann_niv5 = iter_op_res_ann.getCurrentRow();
                                                
                                                if(row_op_last_insc_niv4 == null ){                                                
                                                    // Pas de resultat pour sa derniere inscription
                                                    if(row_op_res_ann_niv5 == null){
                                                        FacesMessage msg = new FacesMessage(" Impossible d'autoriser l'étudiant "+ nom+" "+prenom+" à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
                                                        msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                                        FacesContext.getCurrentInstance().addMessage(null, msg);
                                                        FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Veuillez saisir le resultat de la formation : "+row_op_last_insce.getAttribute("LibNivForm")+" de l'année universitaire : "+row_op_last_insce.getAttribute("LibAnnee")));
                                                        getRowPers(row_det_pers);
                                                    }
                                                    else{
                                                        if( Integer.parseInt(row_op_res_ann_niv5.getAttribute("Resultat").toString()) == 1 ){
                                                            insertAutorisation(id_pers, id_niv_form_parc,id_annee," L'étudiant du nom & prénom : "+nom+"  "+prenom+" est autorisée à s'inscrire en "+row_global_form.getAttribute("LibNivForm"), "NB: Autorisé par Changement de cycle ");                         
                                                        }
                                                        else{
                                                            if(Integer.parseInt(row_op_last_insce.getAttribute("IdAnneesUnivers").toString()) == Integer.parseInt(row_set_annee_passee.getAttribute("IdAnneePasse").toString())){
                                                                FacesMessage msg = new FacesMessage(" Impossible d'autoriser l'étudiant "+ nom+" "+prenom+" à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
                                                                msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                                                FacesContext.getCurrentInstance().addMessage(null, msg);
                                                                
                                                                FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Le dernier niveau de formation ( "+row_op_last_insce.getAttribute("LibNivForm")+" ) inscrit pour l'année universitaire ("+row_op_last_insce.getAttribute("LibAnnee")+" ) n'est pas encore validé"));
                                                                FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" NB : Redoublant ( "+row_op_last_insce.getAttribute("LibNivForm")+" ) "));
                                                                getRowPers(row_det_pers);
                                                            }
                                                            else
                                                                insertAutorisation(id_pers, id_niv_form_parc,id_annee," L'étudiant du nom & prénom : "+nom+"  "+prenom+" est autorisée à s'inscrire en "+row_global_form.getAttribute("LibNivForm"), "NB: Autorisé par Changement de cycle (Par equivalence), ");
                                                        }
                                                    }
                                                }
                                                else{
                                                    //recuperer l'inscription du niveau 4
                                                    if(row_op_last_insc_niv4 != null ){
                                                        //recuperer le resultat du niveau 1
                                                        OperationBinding op_res_ann_niv4 = getBindings().getOperationBinding("getResultatAnnuel");
                                                        op_res_ann_niv4.getParamsMap().put("id_annee",  row_op_last_insc_niv4.getAttribute("IdAnneesUnivers"));
                                                        op_res_ann_niv4.getParamsMap().put("idpers",  Long.parseLong(id_pers));
                                                        op_res_ann_niv4.execute();
                                                        DCIteratorBinding iter_op_res_ann_niv4 = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("ResultatAnnuelROIterator");
                                                        Row row_op_res_ann_niv4 = iter_op_res_ann_niv4.getCurrentRow();
                                                        //recuperer le resultat du niveau 4
                                                        if(row_op_res_ann_niv4 == null ){
                                                            FacesMessage msg = new FacesMessage(" Impossible d'autoriser l'étudiant "+ nom+" "+prenom+" à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
                                                            msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                                            FacesContext.getCurrentInstance().addMessage(null, msg);
                                                            FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Veuillez saisir le resultat de la formation : "+row_op_last_insce.getAttribute("LibNivForm")+" de l'année universitaire : "+row_op_last_insce.getAttribute("LibAnnee")));
                                                            
                                                            getRowPers(row_det_pers);
                                                        }
                                                        else{
                                                            if(Integer.parseInt(row_op_res_ann_niv4.getAttribute("Resultat").toString()) != 1  || Integer.parseInt(row_op_res_ann_niv5.getAttribute("Resultat").toString()) != 1){
                                                                FacesMessage msg = new FacesMessage(" Impossible d'autoriser l'étudiant "+ nom+" "+prenom+" à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
                                                                msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                                                FacesContext.getCurrentInstance().addMessage(null, msg);
                                                                if(row_op_res_ann_niv5 == null)
                                                                    FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Le niveau de formation : "+row_op_last_insce.getAttribute("LibNivForm")+" de l'année universitaire : "+row_op_last_insce.getAttribute("LibAnnee")+" n'est pas encore validé"));
                                                                if(row_op_res_ann_niv4 == null)
                                                                    FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Le niveau de formation : "+row_op_last_insc_niv4.getAttribute("LibNivForm")+" de l'année universitaire : "+row_op_last_insc_niv4.getAttribute("LibAnnee")+" n'est pas encore validé"));

                                                                getRowPers(row_det_pers);
                                                            }
                                                            else{
                                                                if(Integer.parseInt(row_op_res_ann_niv4.getAttribute("Resultat").toString()) == 1  && Integer.parseInt(row_op_res_ann_niv5.getAttribute("Resultat").toString()) == 1 ){
                                                                    inscChangementResultatCycle(id_pers, id_niv_form_parc,id_annee,row_op_last_insce.getAttribute("LibNivForm").toString());
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            else{
                                                FacesMessage msg = new FacesMessage(" Impossible d'autoriser l'étudiant "+ nom+" "+prenom+" à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
                                                msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                                FacesContext.getCurrentInstance().addMessage(null, msg);
                                                FacesContext.getCurrentInstance().addMessage(null, new FacesMessage("Le dernier niveau de formation inscrit :"+row_op_last_insce.getAttribute("LibNivForm")+" pour l'année universitaire : "+row_op_last_insce.getAttribute("LibAnnee")));
                                                getRowPers(row_det_pers);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }}//nb insc ped
            }
            // pas de changement de cycle
            else{
                if(Integer.parseInt(niveau.getInputValue().toString()) != 5){
                    // Pas d'inscription de l'année passée
                    if (row_insc_annee_passee == null) {
                        OperationBinding op_last_insc = getBindings().getOperationBinding("getLastInsc");
                        op_last_insc.getParamsMap().put("idpers",  Long.parseLong(id_pers));
                        op_last_insc.execute();
                        DCIteratorBinding iter_op_last_insc = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("InscAncienneROIterator");
                        Row row_op_last_insce = iter_op_last_insc.getCurrentRow();
                        System.out.println("row_op_last_insce "+row_op_last_insce);
                        // il n'a pas d'inscription ancienne un primo-entrant (Par equivalence)
                        if(row_op_last_insce == null){
                            insertAutorisation(id_pers, id_niv_form_parc,id_annee," L'étudiant du nom & prénom : "+nom+"  "+prenom+" est autorisée à s'inscrire en "+row_global_form.getAttribute("LibNivForm"), "NB: Autorisé (Par equivalence), Primo-entrant");
                        }
                        else{
                            System.out.println("IdEtudiant "+id_etud);
                            OperationBinding op_getNbreInsPed = getBindings().getOperationBinding("getNbreInsPed");
                            op_getNbreInsPed.getParamsMap().put("id_etud",  id_etud);
                            op_getNbreInsPed.getParamsMap().put("id_annee",  row_op_last_insce.getAttribute("IdAnneesUnivers"));
                            Integer nbr_insc_ped_annee_passe = (Integer)op_getNbreInsPed.execute();
                            
                            if(nbr_insc_ped_annee_passe == 2){
                                //Row liste_insc_ped = getListeInscPed(id_etud, id_annee);
                                OperationBinding op_getNiveau_ant = getBindings().getOperationBinding("getListeInscPed");
                                op_getNiveau_ant.getParamsMap().put("id_etud",  id_etud);
                                op_getNiveau_ant.getParamsMap().put("id_annee",  row_op_last_insce.getAttribute("IdAnneesUnivers"));
                                op_getNiveau_ant.execute();
                                /*DCIteratorBinding iter_op_res_ann = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("LesInscPedROIterator");
                                return  iter_op_res_ann.getCurrentRow();*/
                                DCIteratorBinding iter_liste = (DCIteratorBinding)getBindings().get("LesInscPedROIterator");
                                    //Create RowSetIterato iterate over viewObject
                                RowSetIterator rsi_iter_liste = iter_liste.getViewObject().createRowSetIterator(null);
                                Row row_insc_ped_niv_inf = rsi_iter_liste.first();
                                Row row_insc_ped_niv_sup = rsi_iter_liste.last();
                                
                                inscriptionDoubleInscPed(row_insc_ped_niv_inf.getAttribute("IdInscriptionPedagogique").toString(), row_insc_ped_niv_sup.getAttribute("IdInscriptionPedagogique").toString(), Integer.parseInt(niveau.getInputValue().toString()), "id_annee_sup",row_global_form,id_pers, id_etud, id_niv_form_parc, row_det_pers);
                                System.out.println("row_insc_ped_niv_sup "+row_insc_ped_niv_sup.getAttribute("IdInscriptionPedagogique"));
                                System.out.println("row_insc_ped_niv_inf "+row_insc_ped_niv_inf.getAttribute("IdInscriptionPedagogique"));
                            }
                            else{
                            if(nbr_insc_ped_annee_passe == 1){
                            System.out.println("nbr_insc_ped "+nbr_insc_ped_annee_passe);
                            if(Integer.parseInt(row_op_last_insce.getAttribute("Niveau").toString()) == niv_inf){                  
                                OperationBinding op_res_ann = getBindings().getOperationBinding("getResultatAnnuel");
                                op_res_ann.getParamsMap().put("id_annee",  row_op_last_insce.getAttribute("IdAnneesUnivers"));
                                op_res_ann.getParamsMap().put("idpers",  Long.parseLong(id_pers));
                                op_res_ann.execute();
                                DCIteratorBinding iter_op_res_ann = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("ResultatAnnuelROIterator");
                                Row row_op_res_ann = iter_op_res_ann.getCurrentRow();
                                // Pas de resultat pour sa derniere inscription
                                if(row_op_res_ann == null){
                                    FacesMessage msg = new FacesMessage(" Impossible d'autoriser l'étudiant "+ nom+" "+prenom+" à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
                                    msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                    FacesContext.getCurrentInstance().addMessage(null, msg);
                                    FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Veuillez saisir le resultat de la formation : "+row_op_last_insce.getAttribute("LibNivForm")+" de l'année universitaire : "+row_op_last_insce.getAttribute("LibAnnee")));
                                    getRowPers(row_det_pers);
                                }
                                else{
                                    //inscription
                                    System.out.println("getAnne_univers()"+getAnne_univers());
                                    System.out.println("getAnne_univers()"+row_op_last_insce.getAttribute("IdEtudiant"));
                                    System.out.println("id_niv_form_parc"+id_niv_form_parc);
                                    System.out.println("row_global_form.getAttribute(NbreInsPermise)"+row_global_form.getAttribute("NbreInsPermise"));
                                    //une double inscription
                                    OperationBinding op_double_insc = getBindings().getOperationBinding("doubleInscription");
                                    op_double_insc.getParamsMap().put("id_annee",  Long.parseLong(getAnne_univers()));
                                    op_double_insc.getParamsMap().put("id_etud",  row_op_last_insce.getAttribute("IdEtudiant"));     // validation du Responsable de la formation    
                                    op_double_insc.execute();
                                    DCIteratorBinding iter_double_insc = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("InscDoubleROIterator");
                                    Row row_bouble_insc = iter_double_insc.getCurrentRow();
                                    
                                    // nombre max d'insc atteint
                                    OperationBinding op_nombre_insc = getBindings().getOperationBinding("getNombreInscription");
                                    op_nombre_insc.getParamsMap().put("id_parc_maq",  Long.parseLong(id_niv_form_parc));
                                    op_nombre_insc.getParamsMap().put("id_etud",  row_op_last_insce.getAttribute("IdEtudiant"));        
                                    op_nombre_insc.execute();
                                    
                                    DCIteratorBinding iter_nombre_insc = (DCIteratorBinding) getBindings().get("InscNombreMaxiROIterator");        
                                    RowSetIterator rsi_nombre_insc = iter_nombre_insc.getViewObject().createRowSetIterator(null);
                                    if(row_global_form.getAttribute("NbreInsPermise") != null){ 
                                        if(rsi_nombre_insc.getRowCount() < Integer.parseInt( row_global_form.getAttribute("NbreInsPermise").toString())){
                                            if( Integer.parseInt(row_op_res_ann.getAttribute("Resultat").toString()) == 1 || Integer.parseInt(row_op_res_ann.getAttribute("Resultat").toString()) == 2){    
                                                sessionScope.put("idpers_insc_val", id_pers);
                                                sessionScope.put("id_insc_ped_insc_val", row_op_res_ann.getAttribute("IdInscriptionPedagogique"));
                                                sessionScope.put("numero_insc_val", row_op_res_ann.getAttribute("Numero"));
                                                sessionScope.put("id_etud_insc_val", row_op_last_insce.getAttribute("IdEtudiant"));
                                                sessionScope.put("nbr_insc_insc_val", rsi_nombre_insc.getRowCount() + 1);
                                                
                                                System.out.println("Insc validée 1");
                                                
                                                RichPopup popup = this.getPop_insc();
                                                RichPopup.PopupHints hints = new RichPopup.PopupHints();
                                                popup.show(hints);
                                            }
                                            else{
                                                System.out.println("row_insc_annee_passee.getAttribute(\"LibNivForm\")"+row_op_last_insce.getAttribute("LibNivForm"));
                                                FacesMessage msg = new FacesMessage(" Impossible d'autoriser l'étudiant "+ nom+" "+prenom+" à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
                                                msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                                FacesContext.getCurrentInstance().addMessage(null, msg);
                                                FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Le niveau de formation ( "+row_op_last_insce.getAttribute("LibNivForm")+" ) inscrit l'année universitaire passée ("+row_set_annee_passee.getAttribute("IdLibLongPasse")+" ) n'est pas encore validé"));
                                                FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" NB : Redoublant ( "+row_op_last_insce.getAttribute("LibNivForm")+" ) "));
                                                getRowPers(row_det_pers);
                                            }
                                        }

                                        else if(rsi_nombre_insc.getRowCount() >= Integer.parseInt( row_global_form.getAttribute("NbreInsPermise").toString()) && getDerogationEtud(id_niv_form_parc, id_etud, id_annee) == null){
                                                FacesMessage msg = new FacesMessage(" Impossible d'inscrire l'étudiant "+ nom+" "+prenom+" en "+row_global_form.getAttribute("LibNivForm"));
                                                msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                                FacesContext.getCurrentInstance().addMessage(null, msg);
                                                FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" L'étudiant a atteint le nombre maximal d'incription autorisée (max: "+row_global_form.getAttribute("NbreInsPermise")+" inscription(s) permise(s)) pour le Niv. Form ( "+row_op_last_insce.getAttribute("LibNivForm")+" ) "));
                                                while (rsi_nombre_insc.hasNext()) {
                                                     Row row_nombre_insc = rsi_nombre_insc.next();
                                                     FacesContext.getCurrentInstance().addMessage(null, new FacesMessage( row_nombre_insc.getAttribute("LibNivForm")+"  : ("+row_nombre_insc.getAttribute("LibelleLong")+" )"));                             
                                                }
                                                //FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" NB: Le nombre dinscription fixé pour un niveau doit faire lobjet dune dérogation afin de sinscrire"));
                                                getRowPers(row_det_pers);
                                             }
                                        else if(rsi_nombre_insc.getRowCount() >= Integer.parseInt( row_global_form.getAttribute("NbreInsPermise").toString()) && getDerogationEtud(id_niv_form_parc, id_etud, id_annee) != null){ 
                                                insertAutorisation(id_pers, id_niv_form_parc,id_annee," L'étudiant du nom & prénom : "+nom+"  "+prenom+" est autorisée à s'inscrire en "+row_global_form.getAttribute("LibNivForm"), "NB: Autorisé (Par dérogation)");
                                        }
                                    }
                                    //pas de nombre max d'incription
                                    else{
                                        if( Integer.parseInt(row_op_res_ann.getAttribute("Resultat").toString()) == 1 || Integer.parseInt(row_op_res_ann.getAttribute("Resultat").toString()) == 2){    
                                                
                                            System.out.println("Insc validée 2");
                                            sessionScope.put("idpers_insc_val", id_pers);
                                            sessionScope.put("id_insc_ped_insc_val", row_op_last_insce.getAttribute("IdInscriptionPedagogique"));
                                            sessionScope.put("numero_insc_val", row_op_last_insce.getAttribute("Numero"));
                                            sessionScope.put("id_etud_insc_val", row_op_last_insce.getAttribute("IdEtudiant"));
                                            sessionScope.put("nbr_insc_insc_val", rsi_nombre_insc.getRowCount() + 1);
                                            
                                            RichPopup popup = this.getPop_insc();
                                            RichPopup.PopupHints hints = new RichPopup.PopupHints();
                                            popup.show(hints);
                                        }
                                        else{
                                            System.out.println("row_insc_annee_passee.getAttribute(\"LibNivForm\")"+row_op_last_insce.getAttribute("LibNivForm"));
                                            FacesMessage msg = new FacesMessage(" Impossible d'autoriser l'étudiant "+ nom+" "+prenom+" à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
                                            msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                            FacesContext.getCurrentInstance().addMessage(null, msg);
                                            FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Le niveau de formation ( "+row_op_last_insce.getAttribute("LibNivForm")+" ) inscrit l'année universitaire passée ("+row_set_annee_passee.getAttribute("IdLibLongPasse")+" ) n'est pas encore validé"));
                                            FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" NB : Redoublant ( "+row_op_last_insce.getAttribute("LibNivForm")+" ) "));
                                            getRowPers(row_det_pers);
                                        }
                                        
                                    }

                                }
                            }
                            else{
                                //Un ancien étudiant
                                if(Integer.parseInt(row_op_last_insce.getAttribute("Niveau").toString()) < niv_inf && Integer.parseInt(row_op_last_insce.getAttribute("IdAnneesUnivers").toString()) != Integer.parseInt(row_set_annee_passee.getAttribute("IdAnneePasse").toString())){
                                    insertAutorisation(id_pers, id_niv_form_parc,id_annee," L'étudiant du nom & prénom : "+nom+"  "+prenom+" est autorisée à s'inscrire en "+row_global_form.getAttribute("LibNivForm"), "NB: Autorisé (Par equivalence)");
                                }
                                else{
                                    System.out.println(" p1 last niv"+row_op_last_insce.getAttribute("Niveau").toString());
                                    System.out.println(" p1 last inf"+niv_inf);
                                    
                                    if(Integer.parseInt(row_op_last_insce.getAttribute("Niveau").toString()) > niv_inf){
                                        //Le niveau de sa derniere inscription est suppérieure
                                        FacesMessage msg = new FacesMessage(" Impossible d'autoriser l'étudiant "+ nom+" "+prenom+" à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
                                        msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                        FacesContext.getCurrentInstance().addMessage(null, msg);
                                        FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Le dernier niveau de formation inscrit est : "+row_op_last_insce.getAttribute("LibNivForm")+" de l'année universitaire : "+row_op_last_insce.getAttribute("LibAnnee")));
                                        getRowPers(row_det_pers);
                                    }
                                    else{
                                        FacesMessage msg = new FacesMessage(" Impossible d'autoriser l'étudiant "+ nom+" "+prenom+" à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
                                        msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                        FacesContext.getCurrentInstance().addMessage(null, msg);
                                        FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Le dernier niveau de formation inscrit est : "+row_op_last_insce.getAttribute("LibNivForm")+" pour l'année universitaire passée  : "+row_op_last_insce.getAttribute("LibAnnee")));
                                        getRowPers(row_det_pers);
                                    }
                                }
                            }
                            }}//nb insc ped
                        }
                    }
                    // inscription de l'année passée
                    else{System.out.println("niveau.getInputValue()"+niveau.getInputValue()+"niv inf"+niv_inf+" nive "+row_insc_annee_passee.getAttribute("Niveau")+" lib ann "+row_set_annee_passee.getAttribute("IdAnneePasse"));
                         //tester le niveau 
                        if(Integer.parseInt(niveau.getInputValue().toString()) >= 1){
                            if(Integer.parseInt(row_insc_annee_passee.getAttribute("Niveau").toString()) == niv_inf){                  
                                OperationBinding op_res_ann = getBindings().getOperationBinding("getResultatAnnuel");
                                op_res_ann.getParamsMap().put("id_annee",  row_set_annee_passee.getAttribute("IdAnneePasse"));
                                op_res_ann.getParamsMap().put("idpers",  Long.parseLong(id_pers));
                                op_res_ann.execute();
                                DCIteratorBinding iter_op_res_ann = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("ResultatAnnuelROIterator");
                                Row row_op_res_ann = iter_op_res_ann.getCurrentRow();
                                if(row_op_res_ann == null){
                                    FacesMessage msg = new FacesMessage(" Impossible d'autoriser l'étudiant "+ nom+" "+prenom+" à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
                                    msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                    FacesContext.getCurrentInstance().addMessage(null, msg);
                                    FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Veuillez saisir le resultat de la formation : "+row_insc_annee_passee.getAttribute("LibNivForm")+" de l'année universitaire : "+row_set_annee_passee.getAttribute("IdLibLongPasse")));
                                    getRowPers(row_det_pers);
                                }
                                else{//System.out.println("row_op_res_ann "+row_op_res_ann+" res "+row_op_res_ann.getAttribute("Resultat"));
                                    //inscription
                                    OperationBinding op_getNbreInsPed = getBindings().getOperationBinding("getNbreInsPed");
                                    op_getNbreInsPed.getParamsMap().put("id_etud",  id_etud);
                                    op_getNbreInsPed.getParamsMap().put("id_annee",  row_set_annee_passee.getAttribute("IdAnneePasse"));
                                    Integer nbr_insc_ped_annee_passe = (Integer)op_getNbreInsPed.execute();
                                    
                                    if(nbr_insc_ped_annee_passe == 2){
                                        //Row liste_insc_ped = getListeInscPed(id_etud, id_annee);
                                        OperationBinding op_getNiveau_ant = getBindings().getOperationBinding("getListeInscPed");
                                        op_getNiveau_ant.getParamsMap().put("id_etud",  id_etud);
                                        op_getNiveau_ant.getParamsMap().put("id_annee",  row_set_annee_passee.getAttribute("IdAnneePasse"));
                                        op_getNiveau_ant.execute();
                                        /*DCIteratorBinding iter_op_res_ann = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("LesInscPedROIterator");
                                        return  iter_op_res_ann.getCurrentRow();*/
                                        DCIteratorBinding iter_liste = (DCIteratorBinding)getBindings().get("LesInscPedROIterator");
                                            //Create RowSetIterato iterate over viewObject
                                        RowSetIterator rsi_iter_liste = iter_liste.getViewObject().createRowSetIterator(null);
                                        Row row_insc_ped_niv_inf = rsi_iter_liste.first();
                                        Row row_insc_ped_niv_sup = rsi_iter_liste.last();
                                        
                                        inscriptionDoubleInscPed(row_insc_ped_niv_inf.getAttribute("IdInscriptionPedagogique").toString(), row_insc_ped_niv_sup.getAttribute("IdInscriptionPedagogique").toString(), Integer.parseInt(niveau.getInputValue().toString()), "id_annee_sup",row_global_form,id_pers, id_etud, id_niv_form_parc, row_det_pers);
                                        System.out.println("row_insc_ped_niv_sup "+row_insc_ped_niv_sup.getAttribute("IdInscriptionPedagogique"));
                                        System.out.println("row_insc_ped_niv_inf "+row_insc_ped_niv_inf.getAttribute("IdInscriptionPedagogique"));
                                        
                                    }
                                    else{
                                    if(nbr_insc_ped_annee_passe == 1){
                                        // nombre max d'insc atteint
                                        OperationBinding op_nombre_insc = getBindings().getOperationBinding("getNombreInscription");
                                        op_nombre_insc.getParamsMap().put("id_parc_maq",  Long.parseLong(id_niv_form_parc));
                                        op_nombre_insc.getParamsMap().put("id_etud",  row_insc_annee_passee.getAttribute("IdEtudiant"));        
                                        op_nombre_insc.execute();
                                        
                                        DCIteratorBinding iter_nombre_insc = (DCIteratorBinding) getBindings().get("InscNombreMaxiROIterator");        
                                        RowSetIterator rsi_nombre_insc = iter_nombre_insc.getViewObject().createRowSetIterator(null);
                                        
                                        if(row_global_form.getAttribute("NbreInsPermise") != null){
                                            if(rsi_nombre_insc.getRowCount() < Integer.parseInt( row_global_form.getAttribute("NbreInsPermise").toString())){
                                                
                                                if(Integer.parseInt(row_op_res_ann.getAttribute("Resultat").toString()) == 1 || Integer.parseInt(row_op_res_ann.getAttribute("Resultat").toString()) == 2 ){                                                    
                                                    
                                                    System.out.println("Insc validée 2");
                                                    sessionScope.put("idpers_insc_val", id_pers);
                                                    sessionScope.put("id_insc_ped_insc_val", row_op_res_ann.getAttribute("IdInscriptionPedagogique"));
                                                    sessionScope.put("numero_insc_val", row_op_res_ann.getAttribute("Numero"));
                                                    sessionScope.put("id_etud_insc_val", row_insc_annee_passee.getAttribute("IdEtudiant"));
                                                    sessionScope.put("nbr_insc_insc_val", rsi_nombre_insc.getRowCount() + 1);
                                                    
                                                    RichPopup popup = this.getPop_insc();
                                                    RichPopup.PopupHints hints = new RichPopup.PopupHints();
                                                    popup.show(hints);
                                                }
                                                else{
                                                    System.out.println("row_insc_annee_passee.getAttribute(\"LibNivForm\")"+row_insc_annee_passee.getAttribute("LibNivForm"));
                                                    FacesMessage msg = new FacesMessage(" Impossible d'autoriser l'étudiant "+ nom+" "+prenom+" à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
                                                    msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                                    FacesContext.getCurrentInstance().addMessage(null, msg);
                                                    FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Le niveau de formation ( "+row_insc_annee_passee.getAttribute("LibNivForm")+" ) inscrit l'année universitaire passée ("+row_set_annee_passee.getAttribute("IdLibLongPasse")+" ) n'est pas encore validé"));
                                                    FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" NB : Redoublant ( "+row_insc_annee_passee.getAttribute("LibNivForm")+" ) "));
                                                    getRowPers(row_det_pers);
                                                }
                                            }

                                            else if(rsi_nombre_insc.getRowCount() >= Integer.parseInt( row_global_form.getAttribute("NbreInsPermise").toString()) && getDerogationEtud(id_niv_form_parc, id_etud, id_annee) == null){
                                                    FacesMessage msg = new FacesMessage(" Impossible d'inscrire l'étudiant "+ nom+" "+prenom+" en "+row_global_form.getAttribute("LibNivForm"));
                                                    msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                                    FacesContext.getCurrentInstance().addMessage(null, msg);
                                                    FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" L'étudiant a atteint le nombre maximal d'incription autorisée (max: "+row_global_form.getAttribute("NbreInsPermise")+" inscription(s) permise(s)) pour le Niv. Form ( "+row_insc_annee_passee.getAttribute("LibNivForm")+" ) "));
                                                    while (rsi_nombre_insc.hasNext()) {
                                                          Row row_nombre_insc = rsi_nombre_insc.next();
                                                          FacesContext.getCurrentInstance().addMessage(null, new FacesMessage( row_nombre_insc.getAttribute("LibNivForm")+"  : ("+row_nombre_insc.getAttribute("LibelleLong")+" )"));                             
                                                    }
                                                    //FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" NB: Le nombre d'inscription fixé pour un niveau doit faire l'objet d'une dérogation afin de s'inscrire"));
                                                    getRowPers(row_det_pers);
                                                 }
                                            else if(rsi_nombre_insc.getRowCount() >= Integer.parseInt( row_global_form.getAttribute("NbreInsPermise").toString()) && getDerogationEtud(id_niv_form_parc, id_etud, id_annee) != null){ 
                                                    insertAutorisation(id_pers, id_niv_form_parc,id_annee," L'étudiant du nom & prénom : "+nom+"  "+prenom+" est autorisée à s'inscrire en "+row_global_form.getAttribute("LibNivForm"), "NB: Autorisé (Par dérogation)");
                                            }
                                        }
                                        //pas de nombre max d'incription
                                        else{
                                            if(Integer.parseInt(row_op_res_ann.getAttribute("Resultat").toString()) == 1 || Integer.parseInt(row_op_res_ann.getAttribute("Resultat").toString()) == 2 ){                                                                                                   
                                                System.out.println("Insc validée 2");
                                                sessionScope.put("idpers_insc_val", id_pers);
                                                sessionScope.put("id_insc_ped_insc_val", row_op_res_ann.getAttribute("IdInscriptionPedagogique"));
                                                sessionScope.put("numero_insc_val", row_op_res_ann.getAttribute("Numero"));
                                                sessionScope.put("id_etud_insc_val", row_insc_annee_passee.getAttribute("IdEtudiant"));
                                                sessionScope.put("nbr_insc_insc_val", rsi_nombre_insc.getRowCount() + 1);
                                                
                                                RichPopup popup = this.getPop_insc();
                                                RichPopup.PopupHints hints = new RichPopup.PopupHints();
                                                popup.show(hints);
                                            }
                                            else{
                                                System.out.println("row_insc_annee_passee.getAttribute(\"LibNivForm\")"+row_insc_annee_passee.getAttribute("LibNivForm"));
                                                FacesMessage msg = new FacesMessage(" Impossible d'autoriser l'étudiant "+ nom+" "+prenom+" à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
                                                msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                                FacesContext.getCurrentInstance().addMessage(null, msg);
                                                FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Le niveau de formation ( "+row_insc_annee_passee.getAttribute("LibNivForm")+" ) inscrit l'année universitaire passée ("+row_set_annee_passee.getAttribute("IdLibLongPasse")+" ) n'est pas encore validé"));
                                                FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" NB : Redoublant ( "+row_insc_annee_passee.getAttribute("LibNivForm")+" ) "));
                                                getRowPers(row_det_pers);
                                            }
                                            
                                        }
                                }} //nb insc ped
                                }
                            }
                            else{

                                FacesMessage msg = new FacesMessage(" Impossible d'autoriser l'étudiant "+ nom+" "+prenom+" à s'inscrire en "+row_global_form.getAttribute("LibGradeForm"));
                                msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                FacesContext.getCurrentInstance().addMessage(null, msg);
                                FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Le niveau de formation ( "+row_insc_annee_passee.getAttribute("LibNivForm")+" ) inscrit l'année universitaire passée ("+row_set_annee_passee.getAttribute("IdLibLongPasse") ));
                                getRowPers(row_det_pers);
                            }
                        }
            
                    } 
                }
                else{

                    if(Integer.parseInt(niveau.getInputValue().toString()) == 5){
                        
                        OperationBinding op_last_insc = getBindings().getOperationBinding("getLastInsc");
                        op_last_insc.getParamsMap().put("idpers",  Long.parseLong(id_pers));
                        op_last_insc.execute();
                        DCIteratorBinding iter_op_last_insc = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("InscAncienneROIterator");
                        Row row_op_last_insce = iter_op_last_insc.getCurrentRow();
                        if(row_op_last_insce == null){
                            insertAutorisation(id_pers, id_niv_form_parc,id_annee," L'étudiant du nom & prénom : "+nom+"  "+prenom+" est autorisée à s'inscrire en "+row_global_form.getAttribute("LibNivForm"), "NB: Autorisé par Changement de cycle (Par equivalence), Primo-entrant");
                            System.out.println("row_primo ");
                        }
                        else{                        
                            String last_annee = row_op_last_insce.getAttribute("LibAnnee").toString();
                            String lib_annee_cours = row_set_annee_en_cours.getAttribute("LibelleLong").toString();
                            if(Integer.parseInt(row_op_last_insce.getAttribute("Niveau").toString()) == 1 && anneePossible(last_annee,lib_annee_cours,4) > 0){
                                insertAutorisation(id_pers, id_niv_form_parc,id_annee," L'étudiant du nom & prénom : "+nom+"  "+prenom+" est autorisée à s'inscrire en "+row_global_form.getAttribute("LibNivForm"), "NB: Autorisé par Changement de cycle (Par equivalence), ");
                                System.out.println("L'étudiant du nom & prénom : "+nom+"  "+prenom+" : dernier niveau de formation inscrit :"+row_op_last_insce.getAttribute("LibNivForm")+" pour l'année universitaire : "+row_op_last_insce.getAttribute("LibAnnee"));
                            }
                            else{
                                if(Integer.parseInt(row_op_last_insce.getAttribute("Niveau").toString()) == 2 && anneePossible(last_annee,lib_annee_cours,3) > 0){
                                    insertAutorisation(id_pers, id_niv_form_parc,id_annee," L'étudiant du nom & prénom : "+nom+"  "+prenom+" est autorisée à s'inscrire en "+row_global_form.getAttribute("LibNivForm"), "NB: Autorisé par Changement de cycle (Par equivalence), ");
                                    System.out.println("L'étudiant du nom & prénom : "+nom+"  "+prenom+" : dernier niveau de formation inscrit :"+row_op_last_insce.getAttribute("LibNivForm")+" pour l'année universitaire : "+row_op_last_insce.getAttribute("LibAnnee"));
                                }
                                else{
                                    if(Integer.parseInt(row_op_last_insce.getAttribute("Niveau").toString()) == 3 && anneePossible(last_annee,lib_annee_cours,2) > 0){
                                        // inscription du niveau 3
                                        insertAutorisation(id_pers, id_niv_form_parc,id_annee," L'étudiant du nom & prénom : "+nom+"  "+prenom+" est autorisée à s'inscrire en "+row_global_form.getAttribute("LibNivForm"), "NB: Autorisé par Changement de cycle (Par equivalence), ");
                                        System.out.println("L'étudiant du nom & prénom : "+nom+"  "+prenom+" : dernier niveau de formation inscrit :"+row_op_last_insce.getAttribute("LibNivForm")+" pour l'année universitaire : "+row_op_last_insce.getAttribute("LibAnnee"));
                                    }
                                    else{                          
                                        if(Integer.parseInt(row_op_last_insce.getAttribute("Niveau").toString()) == 4 && anneePossible(last_annee,lib_annee_cours,1) > 0){
                                            //recuperer le resultat du niveau 4
                                            OperationBinding op_res_ann = getBindings().getOperationBinding("getResultatAnnuel");
                                            op_res_ann.getParamsMap().put("id_annee",  row_op_last_insce.getAttribute("IdAnneesUnivers"));
                                            op_res_ann.getParamsMap().put("idpers",  Long.parseLong(id_pers));
                                            op_res_ann.execute();
                                            DCIteratorBinding iter_op_res_ann = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("ResultatAnnuelROIterator");
                                            Row row_op_res_ann_niv4 = iter_op_res_ann.getCurrentRow();                                               
                                            // Pas de resultat pour sa derniere inscription
                                            if(row_op_res_ann_niv4 == null){
                                                FacesMessage msg = new FacesMessage(" Impossible d'autoriser l'étudiant "+ nom+" "+prenom+" à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
                                                msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                                FacesContext.getCurrentInstance().addMessage(null, msg);
                                                FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Veuillez saisir le resultat de la formation : "+row_op_last_insce.getAttribute("LibNivForm")+" de l'année universitaire : "+row_op_last_insce.getAttribute("LibAnnee")));
                                                getRowPers(row_det_pers);
                                            }
                                            else{
                                                if( Integer.parseInt(row_op_res_ann_niv4.getAttribute("Resultat").toString()) == 1 ){
                                                    insertAutorisation(id_pers, id_niv_form_parc,id_annee," L'étudiant du nom & prénom : "+nom+"  "+prenom+" est autorisée à s'inscrire en "+row_global_form.getAttribute("LibNivForm"), "");                         
                                                }
                                                else{
                                                    if(Integer.parseInt(row_op_last_insce.getAttribute("IdAnneesUnivers").toString()) == Integer.parseInt(row_set_annee_passee.getAttribute("IdAnneePasse").toString())){
                                                        FacesMessage msg = new FacesMessage(" Impossible d'autoriser l'étudiant "+ nom+" "+prenom+" à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
                                                        msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                                        FacesContext.getCurrentInstance().addMessage(null, msg);
                                                        
                                                        FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Le dernier niveau de formation ( "+row_op_last_insce.getAttribute("LibNivForm")+" ) inscrit pour l'année universitaire ("+row_op_last_insce.getAttribute("LibAnnee")+" ) n'est pas encore validé"));
                                                        FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" NB : Redoublant ( "+row_op_last_insce.getAttribute("LibNivForm")+" ) "));
                                                        getRowPers(row_det_pers);
                                                    }
                                                    else
                                                        insertAutorisation(id_pers, id_niv_form_parc,id_annee," L'étudiant du nom & prénom : "+nom+"  "+prenom+" est autorisée à s'inscrire en "+row_global_form.getAttribute("LibNivForm"), "NB: Autorisé par Changement de cycle (Par equivalence), ");
                                                    }
                                                }
                                            }
                                            else{
                                                FacesMessage msg = new FacesMessage(" Impossible d'autoriser l'étudiant "+ nom+" "+prenom+" à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
                                                msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                                FacesContext.getCurrentInstance().addMessage(null, msg);
                                                FacesContext.getCurrentInstance().addMessage(null, new FacesMessage("Le dernier niveau de formation inscrit :"+row_op_last_insce.getAttribute("LibNivForm")+" pour l'année universitaire : "+row_op_last_insce.getAttribute("LibAnnee")));
                                                getRowPers(row_det_pers);
                                            }
                                        }
                                    }
                                }
                        }
                    }                                    
                }
            }
        }
    }

    @SuppressWarnings("unchecked")
    public void onChangeNumTable(ClientEvent clientEvent) {
        // Add event code here...

        ADFContext adfCtx = ADFContext.getCurrent();
        Map sessionScope = adfCtx.getSessionScope();
        String searchString=(String)clientEvent.getParameters().get("filterKey");
        System.out.println("searchString "+searchString);
        sessionScope.put("tableNotNull", 0);
        sessionScope.put("etudNotNull", 0);
        //tableNotNull
        num_etud.setValue("");
        if(searchString != ""){
            num_etud.setValue("");
            sessionScope.put("tableNotNull", 1);
            try{
                OperationBinding is_nouv_bac = getBindings().getOperationBinding("isNumNouvBac");
                is_nouv_bac.getParamsMap().put("num_table",  Long.parseLong(searchString));
                is_nouv_bac.getParamsMap().put("id_annee",  Long.parseLong(getAnne_univers()));
                Integer result = (Integer)is_nouv_bac.execute();
                //numéro table non valide
                if(result != 0){
                    OperationBinding getIdPersEtudiant = getBindings().getOperationBinding("getIdPersBac");
                    getIdPersEtudiant.getParamsMap().put("num_table",  Long.parseLong(searchString)); 
                    getIdPersEtudiant.getParamsMap().put("id_annee",  Long.parseLong(getAnne_univers()));
                    String result_getid = (String)getIdPersEtudiant.execute();   
                    OperationBinding detpers = getBindings().getOperationBinding("getDetailPers");
                    detpers.getParamsMap().put("idpers_var",  Long.parseLong(result_getid));
                    detpers.execute();
                    
                    DCIteratorBinding iter_det_pers = (DCIteratorBinding)getBindings().get("PersonnesIterator");
                        //Create RowSetIterato iterate over viewObject
                    RowSetIterator rsi_det_pers = iter_det_pers.getViewObject().createRowSetIterator(null);
                    Row row_det_pers = rsi_det_pers.first();
                    if(row_det_pers != null){
                        getRowPers(row_det_pers);
                    }

                }
                else{
                    //Le pays de residance de l'étudiant
                    OperationBinding detpays = getBindings().getOperationBinding("getPaysPers");
                    detpays.execute();

                    //Nationalité de l'étudiant
                    OperationBinding detpays_nation = getBindings().getOperationBinding("getPaysNationalite");
                    detpays_nation.execute();
                    
                    // civilité de l'étudiant
                    OperationBinding op_civilite = getBindings().getOperationBinding("getCivilitePers");
                    op_civilite.execute();
                    
                    // le sexe de l'étudiant
                    OperationBinding op_sexe = getBindings().getOperationBinding("getSexePers");
                    op_sexe.execute();
                    
                    // Série du bachelier
                    OperationBinding op_serie_bac = getBindings().getOperationBinding("getSerieBachelier");
                    op_serie_bac.execute();
                    //Type Mention
                    OperationBinding op_type_mention = getBindings().getOperationBinding("getTypeMent");
                    op_type_mention.execute();
                    //Etablissement de provenance
                    OperationBinding op_lycee = getBindings().getOperationBinding("getLyceeEtab");
                    op_lycee.execute();
                }
                
            }
            catch( Exception e){}
        }
        else{
            //Le pays de residance de l'étudiant
            OperationBinding detpays = getBindings().getOperationBinding("getPaysPers");
            detpays.execute();

            //Nationalité de l'étudiant
            OperationBinding detpays_nation = getBindings().getOperationBinding("getPaysNationalite");
            detpays_nation.execute();
            
            // civilité de l'étudiant
            OperationBinding op_civilite = getBindings().getOperationBinding("getCivilitePers");
            op_civilite.execute();
            
            // le sexe de l'étudiant
            OperationBinding op_sexe = getBindings().getOperationBinding("getSexePers");
            op_sexe.execute();
            
            // Série du bachelier
            OperationBinding op_serie_bac = getBindings().getOperationBinding("getSerieBachelier");
            op_serie_bac.execute();
            //Type Mention
            OperationBinding op_type_mention = getBindings().getOperationBinding("getTypeMent");
            op_type_mention.execute();
            //Etablissement de provenance
            OperationBinding op_lycee = getBindings().getOperationBinding("getLyceeEtab");
            op_lycee.execute();
        }
    }
    @SuppressWarnings("unchecked")
    public void onChangeNumEtud(ClientEvent clientEvent) {
        // Add event code here...
        System.out.println("value apres "+getNum_etud().getValue());
        ADFContext adfCtx = ADFContext.getCurrent();
        Map sessionScope = adfCtx.getSessionScope();
        String searchString=(String)clientEvent.getParameters().get("filterKey");
        System.out.println("searchString searchString "+searchString);
        sessionScope.put("etudNotNull", 0);
        //tableNotNull
        if(searchString != ""){
            sessionScope.put("etudNotNull", 1);
            try{
                OperationBinding isEtudiant = getBindings().getOperationBinding("isNumEtudiant");
                isEtudiant.getParamsMap().put("num_etud",  searchString);
                
                Integer result = (Integer)isEtudiant.execute();System.out.println("result_getid" +result);
                //numéro étudiant non valide
                if(result != 0){
                    //numéro étudiant valide
                    // recuperer id personn de l etudiant
                    OperationBinding getIdPersEtudiant = getBindings().getOperationBinding("getIdPersEtudiant");
                    getIdPersEtudiant.getParamsMap().put("num_etud",  searchString);                            
                    String result_getid = (String)getIdPersEtudiant.execute();   
                    OperationBinding detpers = getBindings().getOperationBinding("getDetailPers");
                    detpers.getParamsMap().put("idpers_var",  Long.parseLong(result_getid));
                    detpers.execute();
                    
                    DCIteratorBinding iter_det_pers = (DCIteratorBinding)getBindings().get("PersonnesIterator");
                        //Create RowSetIterato iterate over viewObject
                    RowSetIterator rsi_det_pers = iter_det_pers.getViewObject().createRowSetIterator(null);
                    Row row_det_pers = rsi_det_pers.first();
                    
                    if(row_det_pers != null){
                        getRowPers(row_det_pers);
                    }

                }
                else{
                    //Le pays de residance de l'étudiant
                    OperationBinding detpays = getBindings().getOperationBinding("getPaysPers");
                    //detpays.getParamsMap().put("id_pays",  null);
                    detpays.execute();

                    //Nationalité de l'étudiant
                    OperationBinding detpays_nation = getBindings().getOperationBinding("getPaysNationalite");
                    //detpays_nation.getParamsMap().put("id_pays",  null);
                    detpays_nation.execute();
                    
                    // civilité de l'étudiant
                    OperationBinding op_civilite = getBindings().getOperationBinding("getCivilitePers");
                    //op_civilite.getParamsMap().put("id_civilite",  null);
                    op_civilite.execute();
                    
                    // le sexe de l'étudiant
                    OperationBinding op_sexe = getBindings().getOperationBinding("getSexePers");
                    op_sexe.execute();
                    
                    // Série du bachelier
                    OperationBinding op_serie_bac = getBindings().getOperationBinding("getSerieBachelier");
                    op_serie_bac.execute();
                    //Type Mention
                    OperationBinding op_type_mention = getBindings().getOperationBinding("getTypeMent");
                    op_type_mention.execute();
                    //Etablissement de provenance
                    OperationBinding op_lycee = getBindings().getOperationBinding("getLyceeEtab");
                    op_lycee.execute();
                }
                
            }
            catch( Exception e){}
        }
        else{
            //Le pays de residance de l'étudiant
            OperationBinding detpays = getBindings().getOperationBinding("getPaysPers");
            detpays.execute();

            //Nationalité de l'étudiant
            OperationBinding detpays_nation = getBindings().getOperationBinding("getPaysNationalite");
            detpays_nation.execute();
            
            // civilité de l'étudiant
            OperationBinding op_civilite = getBindings().getOperationBinding("getCivilitePers");
            op_civilite.execute();
            
            // le sexe de l'étudiant
            OperationBinding op_sexe = getBindings().getOperationBinding("getSexePers");
            op_sexe.execute();
            
            // Série du bachelier
            OperationBinding op_serie_bac = getBindings().getOperationBinding("getSerieBachelier");
            op_serie_bac.execute();
            //Type Mention
            OperationBinding op_type_mention = getBindings().getOperationBinding("getTypeMent");
            op_type_mention.execute();
            //Etablissement de provenance
            OperationBinding op_lycee = getBindings().getOperationBinding("getLyceeEtab");
            op_lycee.execute();
        }
    }
    @SuppressWarnings("unchecked")
    public void onChangeCin(ClientEvent clientEvent) {
        // Add event code here...
        ADFContext adfCtx = ADFContext.getCurrent();
        Map sessionScope = adfCtx.getSessionScope();
        String searchString=(String)clientEvent.getParameters().get("filterKey");
        System.out.println("searchString searchString "+searchString);
        sessionScope.put("cinNotNull", 0);
        //tableNotNull
        if(searchString != ""){
            sessionScope.put("cinNotNull", 1);
            try{
                //vérifier le numéro d'identification
                OperationBinding isEtudiant = getBindings().getOperationBinding("isNumCin");
                isEtudiant.getParamsMap().put("num_cin",  searchString);
                
                Integer result = (Integer)isEtudiant.execute();
                // le numéro d'identification non valide            
                if(result != 0){
                    // le numéro d'identification valide
                    // recuperer id personn de l etudiant
                    OperationBinding getIdPersEtudiant = getBindings().getOperationBinding("getIdPersCin");
                    getIdPersEtudiant.getParamsMap().put("cin",  searchString);  
                    String result_getid = (String)getIdPersEtudiant.execute();   
                    System.out.println("result_getid" +result_getid);
                    sessionScope.put("idpers", Long.parseLong(result_getid));
                    OperationBinding detpers = getBindings().getOperationBinding("getDetailPers");
                    detpers.getParamsMap().put("idpers_var",  Long.parseLong(result_getid));
                    detpers.execute();
                    
                    DCIteratorBinding iter_det_pers = (DCIteratorBinding)getBindings().get("PersonnesIterator");
                        //Create RowSetIterato iterate over viewObject
                    RowSetIterator rsi_det_pers = iter_det_pers.getViewObject().createRowSetIterator(null);
                    Row row_det_pers = rsi_det_pers.first();
                    if(row_det_pers != null){
                        getRowPers(row_det_pers);
                    }

                }
                else{
                    //Le pays de residance de l'étudiant
                    OperationBinding detpays = getBindings().getOperationBinding("getPaysPers");
                    detpays.execute();

                    //Nationalité de l'étudiant
                    OperationBinding detpays_nation = getBindings().getOperationBinding("getPaysNationalite");
                    detpays_nation.execute();
                    
                    // civilité de l'étudiant
                    OperationBinding op_civilite = getBindings().getOperationBinding("getCivilitePers");
                    op_civilite.execute();
                    
                    // le sexe de l'étudiant
                    OperationBinding op_sexe = getBindings().getOperationBinding("getSexePers");
                    op_sexe.execute();
                    
                    // Série du bachelier
                    OperationBinding op_serie_bac = getBindings().getOperationBinding("getSerieBachelier");
                    op_serie_bac.execute();
                    //Type Mention
                    OperationBinding op_type_mention = getBindings().getOperationBinding("getTypeMent");
                    op_type_mention.execute();
                    //Etablissement de provenance
                    OperationBinding op_lycee = getBindings().getOperationBinding("getLyceeEtab");
                    op_lycee.execute();
                }
                
            }
            catch( Exception e){}
        }
        else{
            //Le pays de residance de l'étudiant
            OperationBinding detpays = getBindings().getOperationBinding("getPaysPers");
            //detpays.getParamsMap().put("id_pays",  null);
            detpays.execute();

            //Nationalité de l'étudiant
            OperationBinding detpays_nation = getBindings().getOperationBinding("getPaysNationalite");
            //detpays_nation.getParamsMap().put("id_pays",  null);
            detpays_nation.execute();
            
            // civilité de l'étudiant
            OperationBinding op_civilite = getBindings().getOperationBinding("getCivilitePers");
            //op_civilite.getParamsMap().put("id_civilite",  null);
            op_civilite.execute();
            
            // le sexe de l'étudiant
            OperationBinding op_sexe = getBindings().getOperationBinding("getSexePers");
            op_sexe.execute();
            
            // Série du bachelier
            OperationBinding op_serie_bac = getBindings().getOperationBinding("getSerieBachelier");
            op_serie_bac.execute();
            //Type Mention
            OperationBinding op_type_mention = getBindings().getOperationBinding("getTypeMent");
            op_type_mention.execute();
            //Etablissement de provenance
            OperationBinding op_lycee = getBindings().getOperationBinding("getLyceeEtab");
            op_lycee.execute();
        }
    }

    public void setNum_etud(RichInputText num_etud) {
        this.num_etud = num_etud;
    }

    public RichInputText getNum_etud() {
        return num_etud;
    }

    public void setNum_table(RichInputText num_table) {
        this.num_table = num_table;
    }

    public RichInputText getNum_table() {
        return num_table;
    }

    public void setNum_cin(RichInputText num_cin) {
        this.num_cin = num_cin;
    }

    public RichInputText getNum_cin() {
        return num_cin;
    }

    @SuppressWarnings("unchecked")
    public String onRetirerAutorise() {
        // Add event code here...

        AttributeBinding id_parc_maquette = (AttributeBinding) getBindings().getControlBinding("IdParcoursMaquetAnneeNivForm");
        AttributeBinding id_annee = (AttributeBinding) getBindings().getControlBinding("IdAnneesUnivers");
        
        DCIteratorBinding dciter = (DCIteratorBinding) getBindings().get("ListePersAutNewROIterator");
        Row currentRow = dciter.getCurrentRow();
        
        OperationBinding op_auto_insc = getBindings().getOperationBinding("getInfoAutorise");
        op_auto_insc.getParamsMap().put("id_parc_maq",  Long.parseLong(id_parc_maquette.getInputValue().toString()));
        op_auto_insc.getParamsMap().put("id_annee",  Long.parseLong(id_annee.getInputValue().toString()));  
        op_auto_insc.getParamsMap().put("id_pers",  Long.parseLong(currentRow.getAttribute("IdPersonne").toString()));
        op_auto_insc.execute();
        
        //Valide
        AttributeBinding valide = (AttributeBinding) getBindings().getControlBinding("Valide");
        
        if(Integer.parseInt(valide.getInputValue().toString()) > 0){
            FacesMessage msg = new FacesMessage( " Impossible d'annuler l'autorisation de "+currentRow.getAttribute("Prenoms")+" "+currentRow.getAttribute("Nom")+" ( "+currentRow.getAttribute("Numero")+" )");
            msg.setSeverity(FacesMessage.SEVERITY_ERROR);//
            FacesContext.getCurrentInstance().addMessage(null, msg);
            FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Le Chef de Scolarité a déjà validé"));
        }
        else{
            //isEtudiant getEtudiant
            OperationBinding is_etudiant = getBindings().getOperationBinding("isEtudiant");
            is_etudiant.getParamsMap().put("id_pers",  Long.parseLong(currentRow.getAttribute("IdPersonne").toString()));               
            Integer res_is_etud = (Integer)is_etudiant.execute(); 
            
            if(res_is_etud == 0){
                RichPopup popup = this.getPopup();
                RichPopup.PopupHints hints = new RichPopup.PopupHints();
                popup.show(hints);
            }
            else{
                //info de l'étudiant
                OperationBinding etudiant = BindingContext.getCurrent().getCurrentBindingsEntry().getOperationBinding("getEtudiant");
                etudiant.getParamsMap().put("idpers",  Long.parseLong(currentRow.getAttribute("IdPersonne").toString()));               
                etudiant.execute(); 
                AttributeBinding id_etudiant = (AttributeBinding) getBindings().getControlBinding("IdEtudiant1");
                
                OperationBinding op_double_insc = getBindings().getOperationBinding("doubleInscription");
                op_double_insc.getParamsMap().put("id_annee",  Long.parseLong(id_annee.getInputValue().toString()));
                op_double_insc.getParamsMap().put("id_etud",  Long.parseLong(id_etudiant.getInputValue().toString()));     //     
                op_double_insc.getParamsMap().put("id_parc_maq",  Long.parseLong(id_parc_maquette.getInputValue().toString()));
                op_double_insc.execute();
                DCIteratorBinding iter_double_insc = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("InscDoubleROIterator");
                RowSetIterator rsi = iter_double_insc.getViewObject().createRowSetIterator(null);
                //une inscription de l'année en cours
                if(rsi.getRowCount() > 0){
                    FacesMessage msg = new FacesMessage( " Impossible d'annuler l'autorisation de "+currentRow.getAttribute("Prenoms")+" "+currentRow.getAttribute("Nom")+" ( "+currentRow.getAttribute("Numero")+" )");
                    msg.setSeverity(FacesMessage.SEVERITY_ERROR);//
                    FacesContext.getCurrentInstance().addMessage(null, msg);
                    FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Déjà inscrit pour l'année universitaire en cours"));
                }
                else{
                    RichPopup popup = this.getPopup();
                    RichPopup.PopupHints hints = new RichPopup.PopupHints();
                    popup.show(hints);
                }
            }
        }
        
        return null;
    }

    @SuppressWarnings("unchecked")
    public Integer is_suspendu(Row row){
        Date date_fin_susp = (Date)row.getAttribute("DateFin");
        Integer val_ret = 0;
        SimpleDateFormat date_format_annee = new SimpleDateFormat("yyyy");
        
        //getAnneeEnCours
        OperationBinding getAnneeEnCours = getBindings().getOperationBinding("getAnneeEnCours");
        getAnneeEnCours.getParamsMap().put("id_annee",  Long.parseLong(getAnne_univers()));
        getAnneeEnCours.execute();
        DCIteratorBinding iter_annee_cours = (DCIteratorBinding)getBindings().get("AnneeUniversEnCoursROIterator");
        String annee_cours = iter_annee_cours.getCurrentRow().getAttribute("AnneeCours").toString();

        Integer annee_date_fin = Integer.parseInt(date_format_annee.format(date_fin_susp));
        Integer annee_currente = Integer.parseInt(annee_cours);
        if(annee_date_fin > annee_currente)
            val_ret = 1;
        return val_ret;
    }

    public String onValeurRecup() {
        // Add event code here...
        
        AttributeBinding annee_bac = (AttributeBinding) getBindings().getControlBinding("AnneeBac");
        AttributeBinding serie = (AttributeBinding) getBindings().getControlBinding("IdSerieBac");
        AttributeBinding mode_entree = (AttributeBinding) getBindings().getControlBinding("ModeEntree");
        AttributeBinding type_ment = (AttributeBinding) getBindings().getControlBinding("IdTypeMention");
        AttributeBinding lycee = (AttributeBinding) getBindings().getControlBinding("IdLycee");
        
        AttributeBinding sexe_pers = (AttributeBinding) getBindings().getControlBinding("IdSexePers");
        AttributeBinding ine_pers = (AttributeBinding) getBindings().getControlBinding("Ine");
        AttributeBinding sexe_sexe = (AttributeBinding) getBindings().getControlBinding("IdSexeSexe");
        
        DCIteratorBinding iter_det_pers = (DCIteratorBinding)getBindings().get("PersonnesIterator");
            //Create RowSetIterato iterate over viewObject
        RowSetIterator rsi_det_pers = iter_det_pers.getViewObject().createRowSetIterator(null);
        Row row_det_pers = rsi_det_pers.first();
        if(row_det_pers != null){
            getRowPers(row_det_pers);
        }
        System.out.println("annee_bac "+getBac_nouv());
        System.out.println("serie "+serie.getInputValue());
        System.out.println("mode_entree "+mode_entree.getInputValue());
        System.out.println("type_ment "+type_ment.getInputValue());
        System.out.println("lycee "+lycee.getInputValue());
        
        System.out.println("sexe_pers "+sexe_pers.getInputValue());
        System.out.println("ine_pers "+ine_pers.getInputValue());
        System.out.println("sexe_sexe "+sexe_sexe.getInputValue());
        
        return null;
    }
    // Autorisation d'inscription en cas de changement de cycle
    @SuppressWarnings("unchecked")
    public void inscChangementResultatCycle(String id_pers, String id_niv_form_parc,String id_annee,String form_ant){
        
        AttributeBinding niveau = (AttributeBinding) getBindings().getControlBinding("Niveau");
        Row row_global_form = infoGlobalForm(id_niv_form_parc);
        String lib_cycle="";
        OperationBinding op_result_cycle = getBindings().getOperationBinding("etudiantResultatCycle");
        op_result_cycle.getParamsMap().put("id_pers",  Long.parseLong(id_pers));
        if(Integer.parseInt(niveau.getInputValue().toString()) == 4){
            lib_cycle = " Premier Cycle";
            op_result_cycle.getParamsMap().put("id_prem_cycle",  Long.parseLong("22"));        //id_cycle 22 (premier cycle) 
        }
        else{
            lib_cycle = " Deuxième Cycle";
            op_result_cycle.getParamsMap().put("id_deux_cycle",  Long.parseLong("81"));        //id_cycle 81 (deuxieme cycle) 
        }
        op_result_cycle.execute();
        DCIteratorBinding iter_result_cycle = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("EtudiantResultatCycleROIterator");
        RowSetIterator row_set_res_cycle = iter_result_cycle.getViewObject().createRowSetIterator(null);
        Row row_result_cycle = row_set_res_cycle.last();
        
        // pour reafficher en cas d'erreur
        OperationBinding detpers = getBindings().getOperationBinding("getDetailPers");
        detpers.getParamsMap().put("idpers_var",  Long.parseLong(id_pers));
        detpers.execute();
        
        DCIteratorBinding iter_det_pers = (DCIteratorBinding)getBindings().get("PersonnesIterator");
            //Create RowSetIterato iterate over viewObject
        RowSetIterator rsi_det_pers = iter_det_pers.getViewObject().createRowSetIterator(null);
        Row row_det_pers = rsi_det_pers.first();
        
        // Pas de resultat cycle
        if (row_result_cycle == null) {
            FacesMessage msg = new FacesMessage( " Impossible d'autoriser l'étudiant "+ row_det_pers.getAttribute("Nom")+" "+row_det_pers.getAttribute("Prenoms")+" à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
            msg.setSeverity(FacesMessage.SEVERITY_ERROR);
            FacesContext.getCurrentInstance().addMessage(null, msg);
            FacesContext.getCurrentInstance().addMessage(null, new FacesMessage("Veuillez renseigner le résultat du "+lib_cycle));

            getRowPers(row_det_pers);
            return ;
        }
        else{
            // si l'etudiant a validé le 1er cycle
            if((Integer.parseInt(row_result_cycle.getAttribute("Resultat").toString()) == 1)||(Float.parseFloat(row_result_cycle.getAttribute("Note").toString()) >= 10)) {
                //insert autorisation
                insertAutorisation(id_pers, id_niv_form_parc,id_annee," L'étudiant du nom & prénom : "+row_det_pers.getAttribute("Nom")+" "+row_det_pers.getAttribute("Prenoms")+" est autorisée à s'inscrire en "+row_global_form.getAttribute("LibNivForm"), " NB: Par Changement de cycle");
            }
            else{
                // pour reafficher en cas d'erreur
                getRowPers(row_det_pers);
                // l'etudiant n'a pas validé le cycle précédent
                FacesMessage msg = new FacesMessage( " Impossible d'autoriser l'étudiant "+ row_det_pers.getAttribute("Nom")+" "+row_det_pers.getAttribute("Prenoms")+" à s'inscrire en "+row_global_form.getAttribute("LibGradeForm")+" parce qu'il n'a pas valider le "+row_result_cycle.getAttribute("LibCycle")+" ");
                msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                FacesContext.getCurrentInstance().addMessage(null, msg);
                FacesContext.getCurrentInstance().addMessage(null, new FacesMessage("Le dernier niveau de la formation inscrit est: "+form_ant));
                FacesContext.getCurrentInstance().addMessage(null, new FacesMessage("NB: le "+lib_cycle+" n'est pas validé"));
            }
        }
    }
    public void insertAutorisation(String id_pers, String id_niv_form_parc,String id_annee,String message_pri,String message_sec){
    
        AttributeBinding id_annee_auto = (AttributeBinding) getBindings().getControlBinding("IdAnneesUniversAutorisation");
        AttributeBinding id_pers_auto = (AttributeBinding) getBindings().getControlBinding("IdPersonneAutorise");
        AttributeBinding id_parc_aut = (AttributeBinding) getBindings().getControlBinding("IdParcoursMaquetAnneeAuto");
        AttributeBinding util = (AttributeBinding) getBindings().getControlBinding("UtiCreeAutorisation");
        
        AttributeBinding serie = (AttributeBinding) getBindings().getControlBinding("IdSerieBac");
        AttributeBinding mode_entree = (AttributeBinding) getBindings().getControlBinding("ModeEntree");
        AttributeBinding type_ment = (AttributeBinding) getBindings().getControlBinding("IdTypeMention");
        AttributeBinding lycee = (AttributeBinding) getBindings().getControlBinding("IdLycee");
        //les attributs à modifier
        AttributeBinding id_mode_entree = (AttributeBinding) getBindings().getControlBinding("IdModeEntreeAuto");                
        AttributeBinding id_lycee_auto = (AttributeBinding) getBindings().getControlBinding("IdLyceeAuto");
        AttributeBinding id_serie_bac = (AttributeBinding) getBindings().getControlBinding("IdSerieBacAuto");
        AttributeBinding id_type_ment = (AttributeBinding) getBindings().getControlBinding("IdTypeMentionAuto");
        AttributeBinding annee_bac = (AttributeBinding) getBindings().getControlBinding("AnneeBacAuto");
        
        OperationBinding op_autorise = getBindings().getOperationBinding("CreateInsertAutorises");
        Object result = op_autorise.execute();
        if (!op_autorise.getErrors().isEmpty()) {
            return ;
        }
        else{
            util.setInputValue(Long.parseLong(getUtilisateur()));
            id_annee_auto.setInputValue(Long.parseLong(id_annee));
            id_pers_auto.setInputValue(Long.parseLong(id_pers));
            id_parc_aut.setInputValue(Long.parseLong(id_niv_form_parc));
            
            id_mode_entree.setInputValue(mode_entree.getInputValue());
            id_lycee_auto.setInputValue(lycee.getInputValue());
            id_serie_bac.setInputValue(serie.getInputValue());
            id_type_ment.setInputValue(type_ment.getInputValue());
            annee_bac.setInputValue(getBac_nouv());
            
            OperationBinding op_autorise_commit = getBindings().getOperationBinding("Commit");
            Object result_commit = op_autorise_commit.execute();
            if (!op_autorise_commit.getErrors().isEmpty()) {
                return;
            }           
            else{
                //" NB: Autorisé après avoir annulé son inscription"
                FacesMessage msg = new FacesMessage(message_pri);
                msg.setSeverity(FacesMessage.SEVERITY_INFO);
                FacesMessage msg1 = new FacesMessage(message_sec);
                FacesContext.getCurrentInstance().addMessage(null, msg);
                FacesContext.getCurrentInstance().addMessage(null, msg1);
                sessionScope.put("tableNotNull", 0);
                if((String)this.getNumero() != null ){
                    setNumero("");
                    setPrenom_etud("");
                    setNom_etud("");
                    setDate_naiss_etud("");
                    setLieu_naiss_etud("");
                }
                else
                    if((String)this.getCin_pers() != null ){
                        setCin_pers("");
                        setPrenom_cin("");
                        setNom_cin("");
                        setDate_naiss_cin("");
                        setLieu_naiss_cin("");
                    }
                    else
                        if((String)this.getTable() != null ){
                            setTable("");
                            setPrenom_bac("");
                            setNom_bac("");
                            setDate_naiss_bac("");
                            setLieu_naiss_bac("");
                        }
                    }   
                } 
        }

    @SuppressWarnings("unchecked")
    public void inscriptionValidee(String id_niv_form_parc,String id_pers,String id_etud,String id_annee,String nbr_insc,Row rw_insc_ped){
                
        AttributeBinding id_type_form = (AttributeBinding) getBindings().getControlBinding("IdTypeFormationNivForm");
        AttributeBinding id_grade = (AttributeBinding) getBindings().getControlBinding("IdGradeNivForm");
        AttributeBinding niveau = (AttributeBinding) getBindings().getControlBinding("Niveau");
        
        // pour reafficher en cas d'erreur
        OperationBinding detpers = getBindings().getOperationBinding("getDetailPers");
        detpers.getParamsMap().put("idpers_var",  Long.parseLong(id_pers));
        detpers.execute();
        
        DCIteratorBinding iter_det_pers = (DCIteratorBinding)getBindings().get("PersonnesIterator");
            //Create RowSetIterato iterate over viewObject
        RowSetIterator rsi_det_pers = iter_det_pers.getViewObject().createRowSetIterator(null);
        Row row_det_pers = rsi_det_pers.first();
                
        //getDroitNiveauPays
        
        OperationBinding getDroitNiveauPays = getBindings().getOperationBinding("getDroitNiveauPays");
        getDroitNiveauPays.getParamsMap().put("id_niveau",  Long.parseLong(niveau.getInputValue().toString())); 
        getDroitNiveauPays.getParamsMap().put("id_pays_nation",  row_det_pers.getAttribute("IdPaysNationalite"));
        getDroitNiveauPays.execute(); 
        DCIteratorBinding iter_droit_niv = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("DroitNiveauPaysROIterator");
        Row row_droit_niv_pays = iter_droit_niv.getCurrentRow();
        ///
        //AttributeBinding id_etudiant = (AttributeBinding) getBindings().getControlBinding("IdEtudiant");
        
        AttributeBinding idTypeFormation = (AttributeBinding) getBindings().getControlBinding("IdTypeFormationInscAdmin");
        AttributeBinding id_annee_insc_admin = (AttributeBinding) getBindings().getControlBinding("IdAnneesUniversInscAdmin");
        AttributeBinding idetud = (AttributeBinding) getBindings().getControlBinding("IdEtudiantInscAdmin");
        AttributeBinding idGrade = (AttributeBinding) getBindings().getControlBinding("IdGradeInscAdmin");
        AttributeBinding util_insert_admin = (AttributeBinding) getBindings().getControlBinding("UtiCreeInscAdmin");
        
        //Inscription Administrative
        OperationBinding op_insc_admin = getBindings().getOperationBinding("CreateInsertInscAdmin");
        Object result_op_insc_admin = op_insc_admin.execute();
        if (!op_insc_admin.getErrors().isEmpty()) {
            return ;
        }
        else{
            util_insert_admin.setInputValue(Long.parseLong(getUtilisateur()));
            idTypeFormation.setInputValue(Long.parseLong(id_type_form.getInputValue().toString()));
            id_annee_insc_admin.setInputValue(Long.parseLong(id_annee));
            idetud.setInputValue(Long.parseLong(id_etud));
            idGrade.setInputValue(Long.parseLong(id_grade.getInputValue().toString()));
            
            OperationBinding op_insert_admin_commit = getBindings().getOperationBinding("Commit");
            Object result_insert_admin_commit = op_insert_admin_commit.execute();
            if (!op_insert_admin_commit.getErrors().isEmpty()) {
                return;
            }                               
            else{
                AttributeBinding id_insc_admin = (AttributeBinding) getBindings().getControlBinding("IdInscriptionAdmin");
                
                //les attributs qui seront modifier lors de l'insc
                AttributeBinding id_insc_admin_ped = (AttributeBinding) getBindings().getControlBinding("IdInscriptionAdminPed");
                AttributeBinding id_HorairesTd = (AttributeBinding) getBindings().getControlBinding("IdHorairesTd");
                AttributeBinding id_Statut = (AttributeBinding) getBindings().getControlBinding("IdStatut");
                AttributeBinding id_Option = (AttributeBinding) getBindings().getControlBinding("IdOption");
                AttributeBinding id_Bourse = (AttributeBinding) getBindings().getControlBinding("IdBourse");
                AttributeBinding id_Cohorte = (AttributeBinding) getBindings().getControlBinding("IdCohorte");
                AttributeBinding id_TypeConvention = (AttributeBinding) getBindings().getControlBinding("IdTypeConvention");
                AttributeBinding id_Operateur = (AttributeBinding) getBindings().getControlBinding("IdOperateur");
                AttributeBinding derniere_insc = (AttributeBinding) getBindings().getControlBinding("DernierInscription");
                
                AttributeBinding id_parc_maq_annee = (AttributeBinding) getBindings().getControlBinding("IdParcoursMaquetAnneePed");
                AttributeBinding nb_insc = (AttributeBinding) getBindings().getControlBinding("NbInsc");
                AttributeBinding util_permet_double_insc = (AttributeBinding) getBindings().getControlBinding("UtiPermetDoublInsPed");
                AttributeBinding id_etat_insc = (AttributeBinding) getBindings().getControlBinding("EtatInscrEtatInscrId");
                AttributeBinding tarif = (AttributeBinding) getBindings().getControlBinding("Tarif");
                AttributeBinding orde_insc = (AttributeBinding) getBindings().getControlBinding("OrdreInscription");
                AttributeBinding utilisateur_cree = (AttributeBinding) getBindings().getControlBinding("UtiCreeInscPed");

                AttributeBinding cout_formation = (AttributeBinding) getBindings().getControlBinding("CoutFormation");
                AttributeBinding droit_ins_adm = (AttributeBinding) getBindings().getControlBinding("DroitInsAdm");
                AttributeBinding droit_ins_ped = (AttributeBinding) getBindings().getControlBinding("DroitInsPed");
                
                //Inscription Pédagogique
                OperationBinding op_insc_ped = getBindings().getOperationBinding("CreateInsertInscPed");
                Object result_op_insc_ped = op_insc_ped.execute();
                if (!op_insc_ped.getErrors().isEmpty()) {
                    return ;
                }
                else{
                    // les frais d'inscription
                    Integer droit_insc_admin = 0;
                    Integer droit_insc_ped = 0;
                    if(row_droit_niv_pays.getAttribute("DroitInsAdm") != null && row_droit_niv_pays.getAttribute("DroitInsPed") == null){
                        droit_insc_admin = Integer.parseInt( row_droit_niv_pays.getAttribute("DroitInsAdm").toString());
                        droit_ins_adm.setInputValue(droit_insc_admin);
                        droit_ins_ped.setInputValue(row_droit_niv_pays.getAttribute("DroitInsPed"));
                        cout_formation.setInputValue( 0 + droit_insc_admin);
                    }
                    else{
                        if(row_droit_niv_pays.getAttribute("DroitInsPed") != null && row_droit_niv_pays.getAttribute("DroitInsAdm") == null){
                            droit_insc_ped = Integer.parseInt( row_droit_niv_pays.getAttribute("DroitInsPed").toString());
                            droit_ins_ped.setInputValue(droit_insc_ped);
                            droit_ins_adm.setInputValue(row_droit_niv_pays.getAttribute("DroitInsAdm"));
                            cout_formation.setInputValue( 0 + droit_insc_ped);
                        }
                        else{
                            if(row_droit_niv_pays.getAttribute("DroitInsPed") == null && row_droit_niv_pays.getAttribute("DroitInsAdm") == null){
                                droit_ins_ped.setInputValue(row_droit_niv_pays.getAttribute("DroitInsPed"));
                                droit_ins_adm.setInputValue(row_droit_niv_pays.getAttribute("DroitInsAdm"));
                                cout_formation.setInputValue(null);
                            }
                            else{
                                droit_insc_admin = Integer.parseInt( row_droit_niv_pays.getAttribute("DroitInsAdm").toString());
                                droit_insc_ped = Integer.parseInt( row_droit_niv_pays.getAttribute("DroitInsPed").toString());
                                droit_ins_ped.setInputValue(row_droit_niv_pays.getAttribute("DroitInsPed"));
                                droit_ins_adm.setInputValue(row_droit_niv_pays.getAttribute("DroitInsAdm"));
                                cout_formation.setInputValue(droit_insc_admin + droit_insc_ped);
                            }
                        }
                    }
                    
                    //dernière inscription
                    OperationBinding op_last_insc = getBindings().getOperationBinding("getLastInsc");
                    op_last_insc.getParamsMap().put("idpers",  Long.parseLong(id_pers));
                    op_last_insc.execute();
                    DCIteratorBinding iter_op_last_insc = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("InscAncienneROIterator");
                    Row row_op_last_insce = iter_op_last_insc.getCurrentRow();
                    System.out.println("row_op_last_insce "+row_op_last_insce);
                    
                    id_insc_admin_ped.setInputValue(Long.parseLong(id_insc_admin.getInputValue().toString()));
                    id_HorairesTd.setInputValue(rw_insc_ped.getAttribute("IdHorairesTd"));
                    id_Statut.setInputValue(rw_insc_ped.getAttribute("IdStatut"));
                    id_Option.setInputValue(rw_insc_ped.getAttribute("IdOption"));
                    id_Bourse.setInputValue(rw_insc_ped.getAttribute("IdBourse"));
                    id_Cohorte.setInputValue(rw_insc_ped.getAttribute("IdCohorte"));
                    id_TypeConvention.setInputValue(rw_insc_ped.getAttribute("IdTypeConvention"));
                    id_Operateur.setInputValue(rw_insc_ped.getAttribute("IdOperateur"));
                    if(row_op_last_insce != null)
                        derniere_insc.setInputValue(row_op_last_insce.getAttribute("IdInscriptionPedagogique"));
                    else
                        derniere_insc.setInputValue(Long.parseLong("0"));
                    id_parc_maq_annee.setInputValue(Long.parseLong(id_niv_form_parc));
                    nb_insc.setInputValue(nbr_insc);
                    util_permet_double_insc.setInputValue(Long.parseLong(getUtilisateur())); //utilisateur connecté ou un autre
                    id_etat_insc.setInputValue(Long.parseLong("21")); // etat prvisoire                   
                    utilisateur_cree.setInputValue(Long.parseLong(getUtilisateur()));
                    
                    OperationBinding op_insert_ped_commit = getBindings().getOperationBinding("Commit");
                    Object result_insert_ped_commit = op_insert_ped_commit.execute();
                    if (!op_insert_ped_commit.getErrors().isEmpty()) {
                        return;
                    }                               
                    else{
                        FacesMessage msg = new FacesMessage( " L'étudiant du nom & prénom : "+row_det_pers.getAttribute("Nom")+" "+row_det_pers.getAttribute("Prenoms")+"   ("+sessionScope.get("numero_insc_val")+" ) est inscrit pédagogiquement ");
                        msg.setSeverity(FacesMessage.SEVERITY_INFO);
                        FacesContext.getCurrentInstance().addMessage(null, msg); 
                    }
                }
            }
        } 
        
    }

    public void setPop_insc(RichPopup pop_insc) {
        this.pop_insc = pop_insc;
    }

    public RichPopup getPop_insc() {
        return pop_insc;
    }

    public void onDialogCanInsc(ClientEvent clientEvent) {
        // Add event code here...
        this.getPop_insc().hide();
    }

    @SuppressWarnings("unchecked")
    public void onDialogInsc(DialogEvent dialogEvent) {
        // Add event code here...
        AttributeBinding id_parc_maquette = (AttributeBinding) getBindings().getControlBinding("IdParcoursMaquetAnneeNivForm");
        //getDetailInscPedAnc
        OperationBinding op_insc_ped = getBindings().getOperationBinding("getDetailInscPedAnc");
        op_insc_ped.getParamsMap().put("id_insc_ped",  sessionScope.get("id_insc_ped_insc_val"));
        op_insc_ped.execute();
        DCIteratorBinding iter_op_insc_ped = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("InscPedagogiqueROIterator");
        Row row_op_insc_ped = iter_op_insc_ped.getCurrentRow();        
        inscriptionValidee(id_parc_maquette.getInputValue().toString(), sessionScope.get("idpers_insc_val").toString(),sessionScope.get("id_etud_insc_val").toString(), getAnne_univers(),sessionScope.get("nbr_insc_insc_val").toString(), row_op_insc_ped);       
    }
    public Integer anneePossible(String annee_reussite,String annee_cours,Integer duree){
        String [] reussi = annee_reussite.split("-");
        String [] cours = annee_cours.split("-");
        Integer normale = 0;
        if(Integer.parseInt(cours[0]) >= Integer.parseInt(reussi[0]) + duree){
            normale = 1;
        }
        return normale;
    }

    @SuppressWarnings("unchecked")
    public Row getListeInscPed(String id_etud, String id_annee){
        OperationBinding op_getNiveau_ant = getBindings().getOperationBinding("getListeInscPed");
        op_getNiveau_ant.getParamsMap().put("id_etud",  id_etud);
        op_getNiveau_ant.getParamsMap().put("id_annee",  id_annee);
        op_getNiveau_ant.execute();
        DCIteratorBinding iter_op_res_ann = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("LesInscPedROIterator");
        return  iter_op_res_ann.getCurrentRow();
    }

    @SuppressWarnings("unchecked")
    public Integer getNiveau(String id_etud, String id_annee){
        OperationBinding op_getNiveau_ant = getBindings().getOperationBinding("getNiveau");
        op_getNiveau_ant.getParamsMap().put("id_etud",  id_etud);
        op_getNiveau_ant.getParamsMap().put("id_annee",  id_annee);
        return (Integer)op_getNiveau_ant.execute();
    }

    @SuppressWarnings("unchecked")
    public Row getResultatAnnuelInscPed(String id_insc_ped){
        OperationBinding op_getResult = getBindings().getOperationBinding("getResultatAnnuelInscPed");
        op_getResult.getParamsMap().put("id_insc_ped",  id_insc_ped);
        op_getResult.execute();
        DCIteratorBinding iter_op_res_ann = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("ResultatAnnuelInscPedROIterator");
        return  iter_op_res_ann.getCurrentRow();
    }    

  
    public void inscriptionDoubleInscPed(String id_insc_ped_anc_niv_inf, String id_insc_ped_anc_niv_sup,Integer niv_sup, String id_annee_sup,Row row_global_form,String id_pers, String id_etud, String id_niv_form_parc, Row row_det_pers){
        
        //Integer niveau = getNiveau(id_etud,id_annee);
        Row row_niv_anc_niv_inf = getNiveauInscPed(id_insc_ped_anc_niv_inf);
        Integer niveau_inf = Integer.parseInt(row_niv_anc_niv_inf.getAttribute("Niveau").toString());
        
        Row row_niv_anc_niv_sup = getNiveauInscPed(id_insc_ped_anc_niv_sup);
        
        Integer niveau_sup = Integer.parseInt(row_niv_anc_niv_sup.getAttribute("Niveau").toString());
        
        Row row_op_res_ann_anc_niv_inf = getResultatAnnuelInscPed(id_insc_ped_anc_niv_inf);
        
        Row row_op_res_ann_anc_niv_sup = getResultatAnnuelInscPed(id_insc_ped_anc_niv_sup);
        // Pas de resultat pour sa derniere inscription
        if(row_op_res_ann_anc_niv_inf == null || row_op_res_ann_anc_niv_inf.getAttribute("Resultat") == null || row_op_res_ann_anc_niv_sup == null || row_op_res_ann_anc_niv_sup.getAttribute("Resultat") == null){
            FacesMessage msg = new FacesMessage("Impossible d'inscrire L'étudiant du prénom & nom :  "+row_niv_anc_niv_sup.getAttribute("Prenoms")+"  "+row_niv_anc_niv_sup.getAttribute("Nom")+" ( "+row_niv_anc_niv_sup.getAttribute("Numero")+" ) à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
            msg.setSeverity(FacesMessage.SEVERITY_ERROR);
            FacesContext.getCurrentInstance().addMessage(null, msg);
            //System.out.println("Impossible d'inscrire L'étudiant du prénom & nom :  "+row_niv_anc_niv_sup.getAttribute("Prenoms")+"  "+row_niv_anc_niv_sup.getAttribute("Nom")+" ( "+row_niv_anc_niv_sup.getAttribute("Numero")+" )" );
            if(row_op_res_ann_anc_niv_inf == null)
                //System.out.println(" Veuillez saisir le resultat de la formation : "+row_niv_anc_niv_inf.getAttribute("LibNivForm"));
                FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Veuillez saisir le resultat de la formation : "+row_niv_anc_niv_inf.getAttribute("LibNivForm")+" inscrit pour l'année universitaire :"+row_niv_anc_niv_inf.getAttribute("LibAnnee")));
            if(row_op_res_ann_anc_niv_sup == null)
                //System.out.println(" Veuillez saisir le resultat de la formation : "+row_niv_anc_niv_sup.getAttribute("LibNivForm"));
                FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Veuillez saisir le resultat de la formation : "+row_niv_anc_niv_sup.getAttribute("LibNivForm")+" inscrit pour l'année universitaire :"+row_niv_anc_niv_sup.getAttribute("LibAnnee")));
            
        }
        else{
            // le cas L1 et L2
            if(niveau_sup == 2 ){
                if(niv_sup == (niveau_sup + 1) ){
                    //noteAnnPre.CREDIT = 60) and Ann.CREDIT = 60)
                    if(Integer.parseInt(row_op_res_ann_anc_niv_inf.getAttribute("Resultat").toString()) == 3 && Integer.parseInt(row_op_res_ann_anc_niv_sup.getAttribute("Resultat").toString()) == 1 ){
                        //insc niv superieur
                        //System.out.println("Impossible d'inscrire L'étudiant du prénom & nom :  "+nextRow.getAttribute("Prenomnom")+" ( "+nextRow.getAttribute("Numero")+" )" );
                        System.out.println(" Veuillez saisir le resultat de la formation : ");
                        System.out.println(" Insc niv sup : ");
                        //inscValide(id_pers, id_etud, id_niv_form_parc, row_global_form, row_det_pers, row_niv_anc_niv_sup);
                        insertAutorisation(id_pers, id_niv_form_parc,getAnne_univers()," L'étudiant du nom & prénom : "+row_det_pers.getAttribute("Nom")+" "+row_det_pers.getAttribute("Prenoms")+" est autorisée à s'inscrire en "+row_global_form.getAttribute("LibNivForm"), " NB: Par Changement de cycle");
                        
                    }
                    else{
                        //((noteAnnPre.CREDIT = 60) and (noteAnn.CREDIT < 60) and (noteAnn.CREDIT >= 42))
                        if(Integer.parseInt(row_op_res_ann_anc_niv_inf.getAttribute("Resultat").toString()) == 3 && Integer.parseInt(row_op_res_ann_anc_niv_sup.getAttribute("Resultat").toString()) == 2 ){
                            //passe en L3
                            //enjambiliste L2 et L3
                            //L1 validé
                            insertAutorisation(id_pers, id_niv_form_parc,getAnne_univers()," L'étudiant du nom & prénom : "+row_det_pers.getAttribute("Nom")+" "+row_det_pers.getAttribute("Prenoms")+" est autorisée à s'inscrire en "+row_global_form.getAttribute("LibNivForm"), " NB: Par Changement de cycle");

                        }
                        else{
                            //((noteAnnPre.CREDIT = 60) and (noteAnn.CREDIT < 42))
                            if(Integer.parseInt(row_op_res_ann_anc_niv_inf.getAttribute("Resultat").toString()) == 3 && Integer.parseInt(row_op_res_ann_anc_niv_sup.getAttribute("Resultat").toString()) == 0 ){
                                //Redoublant L2 
                                //L1 validé
                                FacesMessage msg = new FacesMessage("Impossible d'inscrire L'étudiant du prénom & nom :  "+row_niv_anc_niv_sup.getAttribute("Prenoms")+"  "+row_niv_anc_niv_sup.getAttribute("Nom")+" ( "+row_niv_anc_niv_sup.getAttribute("Numero")+" ) à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
                                msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                FacesContext.getCurrentInstance().addMessage(null, msg);
                                FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Le niveau de formation : "+row_niv_anc_niv_sup.getAttribute("LibNivForm")+" inscrit pour l'année universitaire :"+row_niv_anc_niv_sup.getAttribute("LibAnnee")+" n'est pas validé ( crédit obtenu :"+row_op_res_ann_anc_niv_sup.getAttribute("Credit")+") : Redoublant"));
                                FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Le niveau de formation : "+row_niv_anc_niv_inf.getAttribute("LibNivForm")+" inscrit pour l'année universitaire :"+row_niv_anc_niv_inf.getAttribute("LibAnnee")+" est validé ( crédit obtenu :"+row_op_res_ann_anc_niv_inf.getAttribute("Credit")+")"));                            
                            }
                            else{
                                //((noteAnnPre.CREDIT < 60) and (noteAnn.CREDIT = 60))
                                if(Integer.parseInt(row_op_res_ann_anc_niv_inf.getAttribute("Resultat").toString()) == 4 && Integer.parseInt(row_op_res_ann_anc_niv_sup.getAttribute("Resultat").toString()) == 3 ){
                                    //Redoublant L1 
                                    //L2 validé
                                    FacesMessage msg = new FacesMessage("Impossible d'inscrire L'étudiant du prénom & nom :  "+row_niv_anc_niv_sup.getAttribute("Prenoms")+"  "+row_niv_anc_niv_sup.getAttribute("Nom")+" ( "+row_niv_anc_niv_sup.getAttribute("Numero")+" ) à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
                                    msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                    FacesContext.getCurrentInstance().addMessage(null, msg);
                                    FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Le niveau de formation : "+row_niv_anc_niv_sup.getAttribute("LibNivForm")+" inscrit pour l'année universitaire :"+row_niv_anc_niv_sup.getAttribute("LibAnnee")+" est validé ( crédit obtenu :"+row_op_res_ann_anc_niv_sup.getAttribute("Credit")+")"));
                                    FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Le niveau de formation : "+row_niv_anc_niv_sup.getAttribute("LibNivForm")+" inscrit pour l'année universitaire :"+row_niv_anc_niv_inf.getAttribute("LibAnnee")+" n'est pas validé ( crédit obtenu :"+row_op_res_ann_anc_niv_inf.getAttribute("Credit")+")  : Redoublant"));                                 
                                }
                                else{
                                    //((noteAnnPre.CREDIT < 60) and (noteAnn.CREDIT < 60))
                                    if(Integer.parseInt(row_op_res_ann_anc_niv_inf.getAttribute("Resultat").toString()) == 4 && Integer.parseInt(row_op_res_ann_anc_niv_sup.getAttribute("Resultat").toString()) == 4 ){
                                        //Redoublant L1 
                                        //Redoublant L2
                                        FacesMessage msg = new FacesMessage("Impossible d'inscrire L'étudiant du prénom & nom :  "+row_niv_anc_niv_sup.getAttribute("Prenoms")+"  "+row_niv_anc_niv_sup.getAttribute("Nom")+" ( "+row_niv_anc_niv_sup.getAttribute("Numero")+" ) à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
                                        msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                        FacesContext.getCurrentInstance().addMessage(null, msg);
                                        FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Le niveau de formation : "+row_niv_anc_niv_sup.getAttribute("LibNivForm")+" inscrit pour l'année universitaire :"+row_niv_anc_niv_sup.getAttribute("LibAnnee")+" n'est pas validé ( crédit obtenu :"+row_op_res_ann_anc_niv_sup.getAttribute("Credit")+")  : Redoublant"));
                                        FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Le niveau de formation : "+row_niv_anc_niv_inf.getAttribute("LibNivForm")+" inscrit pour l'année universitaire :"+row_niv_anc_niv_inf.getAttribute("LibAnnee")+" n'est pas validé ( crédit obtenu :"+row_op_res_ann_anc_niv_inf.getAttribute("Credit")+") : Redoublant"));                                     
                                    }
                                }
                            }
                        }
                    }
                }

            }
            else{
                // le cas L2 et L3 ou M1 et M2
                if(niveau_sup == 3  ||  niveau_sup == 5){
                    if(niv_sup == (niveau_sup + 1) ){
                        //noteAnnPre.CREDIT = 60) and Ann.CREDIT = 60)
                        if(Integer.parseInt(row_op_res_ann_anc_niv_inf.getAttribute("Resultat").toString()) == 3 && Integer.parseInt(row_op_res_ann_anc_niv_sup.getAttribute("Resultat").toString()) == 5 ){
                            //insc niv superieur
                            //inscValide(id_pers, id_etud, id_niv_form_parc, row_global_form, row_det_pers, row_niv_anc_niv_sup);
                            insertAutorisation(id_pers, id_niv_form_parc,getAnne_univers()," L'étudiant du nom & prénom : "+row_det_pers.getAttribute("Nom")+" "+row_det_pers.getAttribute("Prenoms")+" est autorisée à s'inscrire en "+row_global_form.getAttribute("LibNivForm"), " NB: Par Changement de cycle");
                            //System.out.println(" L'etudiant a déjà validé le niveau de formation : "+row_insc_annee_passee.getAttribute("LibNivForm"));
                        }
                        else{
                            //((noteAnnPre.CREDIT = 60) and (noteAnn.CREDIT < 60))
                            if(Integer.parseInt(row_op_res_ann_anc_niv_inf.getAttribute("Resultat").toString()) == 3 && Integer.parseInt(row_op_res_ann_anc_niv_sup.getAttribute("Resultat").toString()) == 0 ){
                                //Redoublant L3
                                //L2 validé
                                FacesMessage msg = new FacesMessage("Impossible d'inscrire L'étudiant du prénom & nom :  "+row_niv_anc_niv_sup.getAttribute("Prenoms")+"  "+row_niv_anc_niv_sup.getAttribute("Nom")+" ( "+row_niv_anc_niv_sup.getAttribute("Numero")+" ) à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
                                msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                FacesContext.getCurrentInstance().addMessage(null, msg);
                                FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Le niveau de formation : "+row_niv_anc_niv_sup.getAttribute("LibNivForm")+" inscrit pour l'année universitaire :"+row_niv_anc_niv_sup.getAttribute("LibAnnee")+" n'est pas validé ( crédit obtenu :"+row_op_res_ann_anc_niv_sup.getAttribute("Credit")+") : Redoublant"));
                                FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Le niveau de formation : "+row_niv_anc_niv_inf.getAttribute("LibNivForm")+" inscrit pour l'année universitaire :"+row_niv_anc_niv_inf.getAttribute("LibAnnee")+" est validé ( crédit obtenu :"+row_op_res_ann_anc_niv_inf.getAttribute("Credit")+")"));                            
                            }
                            else{
                            
                                //((noteAnnPre.CREDIT < 60) and (noteAnn.CREDIT = 60))
                                if(Integer.parseInt(row_op_res_ann_anc_niv_inf.getAttribute("Resultat").toString()) == 4 && Integer.parseInt(row_op_res_ann_anc_niv_sup.getAttribute("Resultat").toString()) == 3 ){
                                    //Redoublant L2
                                    //L3 validé
                                    FacesMessage msg = new FacesMessage("Impossible d'inscrire L'étudiant du prénom & nom :  "+row_niv_anc_niv_sup.getAttribute("Prenoms")+"  "+row_niv_anc_niv_sup.getAttribute("Nom")+" ( "+row_niv_anc_niv_sup.getAttribute("Numero")+" ) à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
                                    msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                    FacesContext.getCurrentInstance().addMessage(null, msg);
                                    FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Le niveau de formation : "+row_niv_anc_niv_sup.getAttribute("LibNivForm")+" inscrit pour l'année universitaire :"+row_niv_anc_niv_sup.getAttribute("LibAnnee")+" est validé ( crédit obtenu :"+row_op_res_ann_anc_niv_sup.getAttribute("Credit")+")"));
                                    FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Le niveau de formation : "+row_niv_anc_niv_inf.getAttribute("LibNivForm")+" inscrit pour l'année universitaire :"+row_niv_anc_niv_inf.getAttribute("LibAnnee")+" n'est pas validé ( crédit obtenu :"+row_op_res_ann_anc_niv_inf.getAttribute("Credit")+") : Redoublant")); 
                                }
                                else{
                                    //((noteAnnPre.CREDIT < 60) and (noteAnn.CREDIT < 60))
                                    if(Integer.parseInt(row_op_res_ann_anc_niv_inf.getAttribute("Resultat").toString()) == 4 && Integer.parseInt(row_op_res_ann_anc_niv_sup.getAttribute("Resultat").toString()) == 4 ){
                                        //Redoublant L2
                                        //Redoublant L3
                                        FacesMessage msg = new FacesMessage("Impossible d'inscrire L'étudiant du prénom & nom :  "+row_niv_anc_niv_sup.getAttribute("Prenoms")+"  "+row_niv_anc_niv_sup.getAttribute("Nom")+" ( "+row_niv_anc_niv_sup.getAttribute("Numero")+" ) à s'inscrire en "+row_global_form.getAttribute("LibNivForm"));
                                        msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                                        FacesContext.getCurrentInstance().addMessage(null, msg);
                                        FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Le niveau de formation : "+row_niv_anc_niv_sup.getAttribute("LibNivForm")+" inscrit pour l'année universitaire :"+row_niv_anc_niv_sup.getAttribute("LibAnnee")+" n'est pas validé ( crédit obtenu :"+row_op_res_ann_anc_niv_sup.getAttribute("Credit")+")  : Redoublant"));
                                        FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" Le niveau de formation : "+row_niv_anc_niv_inf.getAttribute("LibNivForm")+" inscrit pour l'année universitaire :"+row_niv_anc_niv_inf.getAttribute("LibAnnee")+" n'est pas validé ( crédit obtenu :"+row_op_res_ann_anc_niv_inf.getAttribute("Credit")+") : Redoublant"));
                                    }
                                }
                                
                            }
                        }
                    }
                }
            }
        }
    }
    public Row getNiveauInscPed(String id_insc_ped){
        OperationBinding op_getResult = getBindings().getOperationBinding("getNiveauInscPed");
        op_getResult.getParamsMap().put("id_insc_ped",  id_insc_ped);
        op_getResult.execute();
        DCIteratorBinding iter_op_res_ann = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("NiveauInscPedROIterator");
        return  iter_op_res_ann.getCurrentRow();
    } 
    
    public void inscValide(String id_pers,String id_etud,String id_niv_form_parc,Row row_global_form,Row row_det_pers,Row row_op_res_ann){
        // nombre max d'insc atteint
        OperationBinding op_nombre_insc = getBindings().getOperationBinding("getNombreInscription");
        op_nombre_insc.getParamsMap().put("id_parc_maq",  Long.parseLong(id_niv_form_parc));
        op_nombre_insc.getParamsMap().put("id_etud",  id_etud);        
        op_nombre_insc.execute();
        
        DCIteratorBinding iter_nombre_insc = (DCIteratorBinding) getBindings().get("InscNombreMaxiROIterator");        
        RowSetIterator rsi_nombre_insc = iter_nombre_insc.getViewObject().createRowSetIterator(null);
        System.out.println(" rsi_nombre_insc "+rsi_nombre_insc.getRowCount());
        System.out.println(" NbreInsPermise "+row_global_form.getAttribute("NbreInsPermise") );
        if(row_global_form.getAttribute("NbreInsPermise") != null){
    
            if(rsi_nombre_insc.getRowCount() < Integer.parseInt( row_global_form.getAttribute("NbreInsPermise").toString())){

                sessionScope.put("idpers_insc_val", id_pers);
                sessionScope.put("id_insc_ped_insc_val", row_op_res_ann.getAttribute("IdInscriptionPedagogique"));
                sessionScope.put("numero_insc_val", row_op_res_ann.getAttribute("Numero"));
                sessionScope.put("id_etud_insc_val", row_op_res_ann.getAttribute("IdEtudiant"));
                sessionScope.put("nbr_insc_insc_val", rsi_nombre_insc.getRowCount() + 1);
                
                System.out.println("Insc validée 1");
                
                RichPopup popup = this.getPop_insc();
                RichPopup.PopupHints hints = new RichPopup.PopupHints();
                popup.show(hints);
                    
            }
            else if(rsi_nombre_insc.getRowCount() >= Integer.parseInt( row_global_form.getAttribute("NbreInsPermise").toString())  && getDerogationEtud(id_niv_form_parc, id_etud, getAnne_univers()) == null){
                    FacesMessage msg = new FacesMessage(" Impossible d'inscrire l'étudiant "+ nom+" "+prenom+" en "+row_global_form.getAttribute("LibNivForm"));
                    msg.setSeverity(FacesMessage.SEVERITY_ERROR);
                    FacesContext.getCurrentInstance().addMessage(null, msg);
                    FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" L'étudiant a atteint le nombre maximal d'incription autorisée (max: "+row_global_form.getAttribute("NbreInsPermise")+" inscription(s) permise(s)) pour le Niv. Form ( "+row_global_form.getAttribute("LibNivForm")+" ) "));
                    while (rsi_nombre_insc.hasNext()) {
                              Row row_nombre_insc = rsi_nombre_insc.next();
                              FacesContext.getCurrentInstance().addMessage(null, new FacesMessage( row_nombre_insc.getAttribute("LibNivForm")+"  : ("+row_nombre_insc.getAttribute("LibelleLong")+" )"));                             
                    }
                    //FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(" NB: Le nombre d'inscription fixé pour un niveau doit faire l'objet d'une dérogation afin de s'inscrire"));
                    getRowPers(row_det_pers);
            }
            else if(rsi_nombre_insc.getRowCount() >= Integer.parseInt( row_global_form.getAttribute("NbreInsPermise").toString()) && getDerogationEtud(id_niv_form_parc, id_etud, getAnne_univers()) != null){ 
                    insertAutorisation(id_pers, id_niv_form_parc,getAnne_univers()," L'étudiant du nom & prénom : "+nom+"  "+prenom+" est autorisée à s'inscrire en "+row_global_form.getAttribute("LibNivForm"), "NB: Autorisé (Par dérogation)");
            }
        }
        //pas de nombre max d'incription
        else{
    
            sessionScope.put("idpers_insc_val", id_pers);
            sessionScope.put("id_insc_ped_insc_val", row_op_res_ann.getAttribute("IdInscriptionPedagogique"));
            sessionScope.put("numero_insc_val", row_op_res_ann.getAttribute("Numero"));
            sessionScope.put("id_etud_insc_val", row_op_res_ann.getAttribute("IdEtudiant"));
            sessionScope.put("nbr_insc_insc_val", rsi_nombre_insc.getRowCount() + 1);
            
            System.out.println("Insc validée 1");
            
            RichPopup popup = this.getPop_insc();
            RichPopup.PopupHints hints = new RichPopup.PopupHints();
            popup.show(hints);
                
    
        }
    }
    public Row getDerogationEtud(String id_parc,String id_etud,String id_annee){
        OperationBinding op_getDerogationEtud = getBindings().getOperationBinding("getDerogationEtud");
        op_getDerogationEtud.getParamsMap().put("id_parc",  id_parc);
        op_getDerogationEtud.getParamsMap().put("id_etud",  id_etud);
        op_getDerogationEtud.getParamsMap().put("id_annee",  id_annee);
        op_getDerogationEtud.execute();
        DCIteratorBinding iter_op_res_der = (DCIteratorBinding) BindingContext.getCurrent().getCurrentBindingsEntry().get("DerogationEtudROIterator");
        return  iter_op_res_der.getCurrentRow();
    }
}

